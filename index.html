<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KYK Yemek</title>
    
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/freddiechill/gorsel-depom/refs/heads/main/kykyemek_20251122_043032_0000.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/freddiechill/gorsel-depom/refs/heads/main/kykyemek_20251122_043032_0000.png">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@700,900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Satoshi', sans-serif; font-weight: 700; background-color: #121212; color: #e0e0e0;
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: background-color 0.3s; -webkit-user-select: none; user-select: none;
        }

        /* GİRİŞ BUTONU */
        #auth-container { position: absolute; top: 20px; right: 20px; z-index: 6000; }
        .login-btn {
            background: #fff; color: #333; border: none; padding: 8px 15px; border-radius: 20px;
            font-weight: 900; cursor: pointer; display: flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-family: 'Satoshi', sans-serif; transition: transform 0.2s;
        }
        .login-btn:active { transform: scale(0.95); }
        .user-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd; }

        /* HEADER */
        .header-container { position: relative; width: 100%; text-align: center; z-index: 10; pointer-events: none; margin-top: 60px; margin-bottom: 10px;}
        .date-display { font-size: 1.4rem; color: #fff; margin-top: 5px; text-shadow: 0 4px 12px rgba(0,0,0,0.5); transition: opacity 0.2s; }
        
        /* SOL BUTON */
        .left-controls { position: absolute; top: 20px; left: 20px; z-index: 6000; }
        .icon-btn {
            background: rgba(30, 30, 30, 0.6); backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 50%;
            width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;
            color: #fff; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: transform 0.2s;
        }
        .icon-btn:active { transform: scale(0.9); background: #333; }
        .icon-btn svg { width: 24px; height: 24px; fill: currentColor; pointer-events: none; }

        /* CAROUSEL */
        .carousel-container { position: relative; width: 100%; height: 65vh; perspective: 1000px; display: flex; align-items: center; justify-content: center; }
        .menu-card {
            position: absolute; top: 50%; left: 50%; width: 85%; max-width: 380px; height: auto; max-height: 55vh;
            background: #1e1e1e; border-radius: 24px; border: 2px solid #333;
            box-shadow: 0 15px 40px rgba(0,0,0,0.6); display: flex; flex-direction: column; overflow: hidden;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.4s, border-color 0.3s; padding-bottom: 10px;
        }
        .pos-2 { z-index: 30; transform: translate(-50%, -50%) scale(1); opacity: 1; }
        .pos-1 { z-index: 20; transform: translate(-85%, -50%) scale(0.85); opacity: 0.5; pointer-events: none; }
        .pos-3 { z-index: 20; transform: translate(-15%, -50%) scale(0.85); opacity: 0.5; pointer-events: none; }
        .pos-0 { z-index: 10; transform: translate(-150%, -50%) scale(0.7); opacity: 0; }
        .pos-4 { z-index: 10; transform: translate(50%, -50%) scale(0.7); opacity: 0; }

        .card-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: rgba(255,255,255,0.03); border-bottom: 1px solid #333; min-height: 50px; }
        .meal-title { font-size: 1.2rem; font-weight: 900; text-transform: uppercase; }
        .switch-btn { background: #333; color: #fff; border: none; padding: 6px 12px; border-radius: 20px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 5px; font-family: 'Satoshi', sans-serif; font-size: 0.8rem; }
        .pos-2 .switch-btn { opacity: 1; pointer-events: auto; }

        ul { list-style: none; padding: 10px 0; margin: 0; overflow-y: auto; flex: 1; }
        li { padding: 12px 20px; border-bottom: 1px solid #2c2c2c; font-size: 1.05rem; text-align: center; color: #ddd; }
        li:last-child { border-bottom: none; }

        /* SOSYAL FOOTER */
        .social-footer { display: flex; justify-content: space-around; align-items: center; padding: 12px; background: #151515; border-top: 1px solid #333; }
        .social-action { display: flex; flex-direction: column; align-items: center; color: #888; cursor: pointer; transition: color 0.2s; position: relative; width: 60px; }
        .social-action:active { transform: scale(0.9); }
        .social-action svg { width: 26px; height: 26px; fill: currentColor; margin-bottom: 2px; flex-shrink: 0; }
        .count-text { font-size: 0.8rem; font-weight: bold; font-variant-numeric: tabular-nums; }
        .liked { color: #ef9a9a !important; } .disliked { color: #90caf9 !important; }

        /* NAVIGASYON */
        .nav-btn { position: absolute; top: 50%; transform: translateY(-50%); width: 80px; height: 80vh; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100; background: transparent; border: none; color: rgba(255,255,255,0.3); }
        .nav-left { left: 0; justify-content: flex-start; padding-left: 10px; }
        .nav-right { right: 0; justify-content: flex-end; padding-right: 10px; }

        /* Temalar */
        body.theme-breakfast .menu-card { border-color: #fff59d; } body.theme-breakfast .meal-title { color: #fff59d; } body.theme-breakfast .switch-btn { background: #fff59d; color: #121212; }
        body.theme-dinner .menu-card { border-color: #ef9a9a; } body.theme-dinner .meal-title { color: #ef9a9a; } body.theme-dinner .switch-btn { background: #ef9a9a; color: #121212; }

        /* AUTH MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 7000; align-items: center; justify-content: center; }
        .auth-box { background: #1e1e1e; padding: 25px; border-radius: 20px; width: 90%; max-width: 350px; border: 1px solid #333; text-align: center; position: relative; }
        .auth-tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #333; }
        .auth-tab { flex: 1; padding: 10px; cursor: pointer; color: #888; font-weight: bold; transition: 0.3s; }
        .auth-tab.active { color: #fff; border-bottom: 2px solid #fff; }
        .auth-input { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 10px; border: 1px solid #444; background: #252525; color: #fff; box-sizing: border-box; font-family: 'Satoshi', sans-serif; outline: none; }
        .auth-submit { width: 100%; padding: 12px; border-radius: 10px; border: none; background: #fff; color: #000; font-weight: 900; cursor: pointer; font-family: 'Satoshi', sans-serif; transition: transform 0.2s; }
        .auth-submit:active { transform: scale(0.95); }
        .auth-close { margin-top: 15px; color: #888; cursor: pointer; font-size: 0.9rem; display: block; }

        /* Avatar Upload */
        .avatar-upload { width: 80px; height: 80px; border-radius: 50%; background: #333; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; border: 2px dashed #555; position: relative; }
        .avatar-upload img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .avatar-upload span { font-size: 0.8rem; color: #888; }
        #fileInput { display: none; }

        /* YORUM MODALI */
        .comment-modal, #fullListModal { display: none; position: fixed; background: #121212; box-sizing: border-box; }
        .comment-modal { bottom: 0; left: 0; width: 100%; height: 70vh; border-radius: 24px 24px 0 0; z-index: 7000; padding: 20px; background: #1e1e1e; box-shadow: 0 -10px 30px rgba(0,0,0,0.7); flex-direction: column; }
        #fullListModal { top: 0; left: 0; width: 100%; height: 100%; z-index: 4000; padding: 20px; padding-top: 80px; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; color:#fff; font-size:1.2rem; font-weight: bold; }
        .comment-list, .modal-scroll-area { flex: 1; overflow-y: auto; margin-bottom: 10px; }
        
        /* Yorum Kartı */
        .single-comment { background: #252525; padding: 10px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #333; display: flex; gap: 10px; }
        .c-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; flex-shrink: 0; background: #444; }
        .c-content { flex: 1; }
        .c-user { font-size: 0.85rem; color: #ccc; font-weight: bold; margin-bottom: 2px; }
        .c-text { font-size: 0.95rem; color: #fff; }
        
        .comment-input-area { display: flex; gap: 10px; }
        .comment-input { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #444; background: #121212; color: #fff; font-family: 'Satoshi', sans-serif; outline: none;}
        .send-btn { background: #ef9a9a; border: none; padding: 0 20px; border-radius: 10px; font-weight: bold; cursor: pointer; color: #121212; font-family: 'Satoshi', sans-serif;}

        .day-row { background: #1e1e1e; margin-bottom: 15px; border-radius: 10px; padding: 15px; border: 1px solid #333; }
        .day-header { font-size: 1.1rem; color: #888; margin-bottom: 10px; text-align: center; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .day-content { font-size: 1rem; line-height: 1.6; text-align: center; color: #e0e0e0; white-space: pre-line; }
        .modal-toggle-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .modal-toggle { padding: 10px 20px; border-radius: 10px; border: 1px solid #444; background: #1e1e1e; color: #888; font-family: 'Satoshi', sans-serif; font-weight: 700; cursor: pointer; }
        .modal-toggle.active-yellow { background: #fff59d; color: #121212; border-color: #fff59d; }
        .modal-toggle.active-red { background: #ef9a9a; color: #121212; border-color: #ef9a9a; }

        @media (min-width: 768px) {
            .menu-card { max-width: 400px; max-height: 60vh; }
            .nav-btn { width: 120px; }
        }
    </style>
</head>
<body class="theme-dinner">

    <div class="left-controls">
        <button class="icon-btn" onclick="toggleModal()" title="Tüm Liste">
            <svg id="icon-eye" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
        </button>
    </div>

    <div id="auth-container">
        <button class="login-btn" onclick="openAuthModal()">
            Giriş / Kayıt
        </button>
    </div>

    <div class="header-container">
        <div class="date-display" id="currentDate">Yükleniyor...</div>
    </div>

    <div class="carousel-container">
        <button class="nav-btn nav-left" onclick="moveCarousel(-1)"><svg viewBox="0 0 24 24" width="30" height="30" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg></button>
        <button class="nav-btn nav-right" onclick="moveCarousel(1)"><svg viewBox="0 0 24 24" width="30" height="30" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></button>
        <div class="menu-card" id="c0"></div>
        <div class="menu-card" id="c1"></div>
        <div class="menu-card" id="c2"></div>
        <div class="menu-card" id="c3"></div>
        <div class="menu-card" id="c4"></div>
    </div>

    <div id="authModal" class="modal-overlay">
        <div class="auth-box">
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuthTab('login')">Giriş Yap</div>
                <div class="auth-tab" onclick="switchAuthTab('register')">Kayıt Ol</div>
            </div>

            <div id="loginForm">
                <input type="email" id="loginEmail" class="auth-input" placeholder="E-posta">
                <input type="password" id="loginPass" class="auth-input" placeholder="Şifre">
                <button class="auth-submit" onclick="loginUser()">GİRİŞ YAP</button>
            </div>

            <div id="registerForm" style="display:none;">
                <div class="avatar-upload" onclick="document.getElementById('fileInput').click()">
                    <span id="avatarLabel">FOTO</span>
                    <img id="avatarPreview">
                </div>
                <input type="file" id="fileInput" accept="image/*" onchange="handleAvatarSelect(this)">
                
                <input type="text" id="regNick" class="auth-input" placeholder="Kullanıcı Adı (Nick)">
                <input type="email" id="regEmail" class="auth-input" placeholder="E-posta">
                <input type="password" id="regPass" class="auth-input" placeholder="Şifre (En az 6 karakter)">
                <button class="auth-submit" onclick="registerUser()">KAYIT OL</button>
            </div>
            <span class="auth-close" onclick="closeAuthModal()">Kapat</span>
        </div>
    </div>

    <div id="commentModal" class="comment-modal">
        <div class="comment-header">
            <span>Yorumlar</span>
            <span onclick="closeComments()" style="cursor:pointer">&times;</span>
        </div>
        <div class="comment-list" id="commentList"></div>
        <div class="comment-input-area">
            <input type="text" id="commentInput" class="comment-input" placeholder="Bir şeyler yaz...">
            <button class="send-btn" onclick="postComment()">Gönder</button>
        </div>
    </div>

    <div id="fullListModal">
        <div class="modal-header">Tüm Ayın Listesi</div>
        <div class="modal-toggle-container">
            <button class="modal-toggle" id="modalBtnBreakfast" onclick="renderFullList('breakfast')">Kahvaltı</button>
            <button class="modal-toggle" id="modalBtnDinner" onclick="renderFullList('dinner')">Akşam</button>
        </div>
        <div class="modal-scroll-area" id="fullListContainer"></div>
    </div>

<script>
    // --- API AYARLARI ---
    const firebaseConfig = {
        apiKey: "AIzaSyDhYvJ6v8F9e7PsdkY7VXGjQW2iTUbVHQY",
        authDomain: "kyk-yemek-app.firebaseapp.com",
        projectId: "kyk-yemek-app",
        storageBucket: "kyk-yemek-app.firebasestorage.app",
        messagingSenderId: "177253204360",
        appId: "1:177253204360:web:0b0516ad80df3e5658fa3d",
        measurementId: "G-EGGGN0B9J5"
    };

    let db, auth;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();
    } catch (e) { console.log(e); }

    let currentUser = null;
    let selectedAvatarBase64 = null; // Seçilen fotoyu burada tut

    // --- OTURUM YÖNETİMİ ---
    if(auth) {
        auth.onAuthStateChanged((user) => {
            if (user) { currentUser = user; updateLoginButton(); closeAuthModal(); }
            else { currentUser = null; updateLoginButton(); }
        });
    }

    function updateLoginButton() {
        const container = document.getElementById('auth-container');
        if(currentUser) {
            const name = currentUser.displayName || "Üye";
            const photo = currentUser.photoURL || ""; 
            // Varsayılan ikon eğer foto yoksa
            const imgHtml = photo ? `<img src="${photo}" class="user-avatar">` : `<div class="user-avatar">${name.charAt(0).toUpperCase()}</div>`;
            
            container.innerHTML = `
                <div class="login-btn" onclick="openAuthModal()">
                    ${imgHtml}
                    <span>${name}</span>
                </div>`;
        } else {
            container.innerHTML = `<button class="login-btn" onclick="openAuthModal()">Giriş / Kayıt</button>`;
        }
    }

    function openAuthModal() {
        if(currentUser) {
            if(confirm("Çıkış yapmak istiyor musunuz?")) auth.signOut();
        } else {
            document.getElementById('authModal').style.display = 'flex';
        }
    }
    function closeAuthModal() { document.getElementById('authModal').style.display = 'none'; }
    
    function switchAuthTab(tab) {
        if(tab === 'login') {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.querySelectorAll('.auth-tab')[0].classList.add('active');
            document.querySelectorAll('.auth-tab')[1].classList.remove('active');
        } else {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.querySelectorAll('.auth-tab')[0].classList.remove('active');
            document.querySelectorAll('.auth-tab')[1].classList.add('active');
        }
    }

    // FOTOĞRAF İŞLEME (RESIZE & BASE64)
    function handleAvatarSelect(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                // Resmi küçültmek için Canvas kullanalım (Veritabanı şişmesin)
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    // Maks 150px
                    const maxSize = 150;
                    let width = img.width;
                    let height = img.height;
                    if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } }
                    else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Base64 stringi al
                    selectedAvatarBase64 = canvas.toDataURL('image/jpeg', 0.7); // %70 kalite
                    
                    // Önizleme göster
                    document.getElementById('avatarPreview').src = selectedAvatarBase64;
                    document.getElementById('avatarPreview').style.display = 'block';
                    document.getElementById('avatarLabel').style.display = 'none';
                };
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }
    }

    // KAYIT OL (NICK KONTROLÜ + AVATAR)
    async function registerUser() {
        const nick = document.getElementById('regNick').value.trim();
        const email = document.getElementById('regEmail').value.trim();
        const pass = document.getElementById('regPass').value;

        if(!nick || !email || !pass) return alert("Tüm alanları doldurun.");

        try {
            // 1. Nick Benzersiz mi?
            const nickCheck = await db.collection('usernames').doc(nick).get();
            if(nickCheck.exists) {
                return alert("Bu kullanıcı adı zaten alınmış. Başka bir tane seçin.");
            }

            // 2. Kullanıcıyı oluştur
            const userCred = await auth.createUserWithEmailAndPassword(email, pass);
            const user = userCred.user;

            // 3. Profili Güncelle (Nick + Foto)
            await user.updateProfile({
                displayName: nick,
                photoURL: selectedAvatarBase64 // Küçük fotoyu profile kaydet
            });

            // 4. Nicki rezerve et
            await db.collection('usernames').doc(nick).set({ uid: user.uid });

            alert("Kayıt başarılı!");
            closeAuthModal();

        } catch (error) {
            alert("Hata: " + error.message);
        }
    }

    function loginUser() {
        const email = document.getElementById('loginEmail').value;
        const pass = document.getElementById('loginPass').value;
        if(!email || !pass) return alert("Bilgileri girin.");
        auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
    }

    // --- VERİLER VE UI (AYNI) ---
    const menuData = {
        1: { date: "1 Kasım 2025 Cumartesi", breakfast: ["Menemen", "Sade Poğaça", "Kaşar Peynir", "Siyah/Yeşil Zeytin", "Tahinli Pekmez", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Kırmızı Mercimek Çorba / Sebze Çorba", "Tavuk Külbastı Fırın Sebze / Taze Fasulye", "Bulgur Pilavı", "Bahçe Salata", "500 ml Su", "Çeyrek Ekmek"] },
        // ... (Tam liste buraya, önceki kodlardaki gibi)
        20: { date: "20 Kasım 2025 Perşembe", breakfast: ["Sosis Kokteyl/Patates Kavurması", "Yumurta", "Peynir", "Zeytin", "Çeyrek Ekmek"], dinner: ["Mısır Çorba", "İzmir Köfte", "Bulgur", "Babagannuş"] },
    };
    for(let i=1; i<=30; i++) { if(!menuData[i]) menuData[i] = {date: i+" Kasım", breakfast:["Veri Yok"], dinner:["Veri Yok"]}; }

    let currentMeal = 'dinner';
    let currentDayIndex = new Date().getDate();
    let cardPositions = [0, 1, 2, 3, 4];
    const cards = [document.getElementById('c0'), document.getElementById('c1'), document.getElementById('c2'), document.getElementById('c3'), document.getElementById('c4')];

    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date();
        if(today.getMonth() !== 10 || currentDayIndex > 30) currentDayIndex = 1;
        updateTheme();
        renderAllCards(currentDayIndex);
        applyClasses();
    });

    function getLoopedIndex(idx) { let val = idx; while(val<1) val+=30; while(val>30) val-=30; return val; }

    function renderAllCards(centerDateIdx) {
        for (let i = 0; i < 5; i++) {
            const domIndex = cardPositions[i];
            const dateOffset = i - 2;
            const targetDateIdx = getLoopedIndex(centerDateIdx + dateOffset);
            const card = cards[domIndex];
            
            card.innerHTML = `
                <div class="card-header">
                    <div class="meal-title">${currentMeal === 'breakfast' ? 'KAHVALTI' : 'AKŞAM'}</div>
                    <button class="switch-btn ${i===2?'':'hidden-btn'}" onclick="toggleMealType()">
                        <span class="switch-text">${currentMeal === 'breakfast' ? 'Akşama Geç' : 'Kahvaltıya Geç'}</span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M16.01 11H4v2h12.01v3L20 12l-3.99-4z"/></svg>
                    </button>
                </div>
                <ul>${getMenuHtml(targetDateIdx)}</ul>
                
                <div class="social-footer">
                    <div class="social-action" onclick="handleVote(${targetDateIdx}, 'like')">
                        <svg viewBox="0 0 24 24"><path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-1.91l-.99-.01z"/></svg>
                        <span class="count-text" id="like-count-${targetDateIdx}">0</span>
                    </div>
                    <div class="social-action" onclick="handleVote(${targetDateIdx}, 'dislike')">
                        <svg viewBox="0 0 24 24"><path d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v1.91l.99.01h3.8c.43 0 .83.22 1.07.58l.79 1.19.79 1.19c.24.36.24.83-.01 1.19l-2.42 3.63c-.27.41-.19.96.19 1.27.16.13.36.2.56.2h9.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L15.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z"/></svg>
                        <span class="count-text" id="dislike-count-${targetDateIdx}">0</span>
                    </div>
                    <div class="social-action" onclick="openComments(${targetDateIdx})">
                        <svg viewBox="0 0 24 24"><path d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18z"/></svg>
                        <span class="count-text" id="comment-count-${targetDateIdx}">0</span>
                    </div>
                </div>
            `;
            if(i===2) {
                document.getElementById('currentDate').innerText = menuData[targetDateIdx].date;
                fetchStats(targetDateIdx);
            }
        }
    }

    function getMenuHtml(idx) {
        const items = (menuData[idx] && menuData[idx][currentMeal]) ? menuData[idx][currentMeal] : ["Veri yok"];
        return items.map(i => `<li>${i}</li>`).join('');
    }

    function moveCarousel(direction) {
        if(direction===1) { cardPositions.push(cardPositions.shift()); currentDayIndex = getLoopedIndex(currentDayIndex+1); } 
        else { cardPositions.unshift(cardPositions.pop()); currentDayIndex = getLoopedIndex(currentDayIndex-1); }
        renderAllCards(currentDayIndex);
        applyClasses();
    }
    function applyClasses() {
        const classes = ['pos-0', 'pos-1', 'pos-2', 'pos-3', 'pos-4'];
        for(let i=0; i<5; i++) {
            const el = cards[cardPositions[i]];
            el.classList.remove(...classes);
            el.classList.add(classes[i]);
        }
    }
    function toggleMealType() { currentMeal = currentMeal === 'dinner' ? 'breakfast' : 'dinner'; updateTheme(); renderAllCards(currentDayIndex); }
    function updateTheme() { document.body.className = currentMeal === 'breakfast' ? 'theme-breakfast' : 'theme-dinner'; }
    function toggleModal() {
        const modal = document.getElementById('fullListModal'); const eyeIcon = document.getElementById('icon-eye'); const eyeOffIcon = document.getElementById('icon-eye-off');
        if (modal.style.display === 'flex') { modal.style.display = 'none'; eyeIcon.style.display = 'block'; eyeOffIcon.style.display = 'none'; } 
        else { modal.style.display = 'flex'; eyeIcon.style.display = 'none'; eyeOffIcon.style.display = 'block'; renderFullList(currentMeal); }
    }
    function renderFullList(mealType) {
        const container = document.getElementById('fullListContainer'); const btnBreakfast = document.getElementById('modalBtnBreakfast'); const btnDinner = document.getElementById('modalBtnDinner');
        container.innerHTML = ''; btnBreakfast.className = 'modal-toggle'; btnDinner.className = 'modal-toggle';
        if (mealType === 'breakfast') btnBreakfast.classList.add('active-yellow'); else btnDinner.classList.add('active-red');
        for (let i = 1; i <= 30; i++) {
            const dayData = menuData[i];
            if (dayData) {
                const div = document.createElement('div'); div.className = 'day-row';
                div.innerHTML = `<div class="day-header">${dayData.date}</div><div class="day-content">${dayData[mealType].join('<br>')}</div>`;
                container.appendChild(div);
            }
        }
    }

    // --- FIREBASE İŞLEMLERİ ---
    function fetchStats(dayIdx) {
        if(!db) return;
        const docId = `${currentMeal}_nov_${dayIdx}`;
        db.collection('daily_stats').doc(docId).onSnapshot(doc => {
            if(doc.exists) {
                const data = doc.data();
                document.getElementById(`like-count-${dayIdx}`).innerText = data.likes || 0;
                document.getElementById(`dislike-count-${dayIdx}`).innerText = data.dislikes || 0;
                document.getElementById(`comment-count-${dayIdx}`).innerText = data.commentCount || 0;
                
                if(currentUser && data.votes && data.votes[currentUser.uid]) {
                    if(data.votes[currentUser.uid] === 'like') {
                        document.getElementById(`like-count-${dayIdx}`).parentElement.classList.add('liked');
                        document.getElementById(`dislike-count-${dayIdx}`).parentElement.classList.remove('disliked');
                    } else {
                        document.getElementById(`dislike-count-${dayIdx}`).parentElement.classList.add('disliked');
                        document.getElementById(`like-count-${dayIdx}`).parentElement.classList.remove('liked');
                    }
                }
            }
        });
    }

    function handleVote(dayIdx, type) {
        if(!currentUser) return alert("Lütfen giriş yapın.");
        if(!db) return;
        const docId = `${currentMeal}_nov_${dayIdx}`;
        const docRef = db.collection('daily_stats').doc(docId);

        db.runTransaction(async (transaction) => {
            const doc = await transaction.get(docRef);
            if (!doc.exists) {
                transaction.set(docRef, { likes: 0, dislikes: 0, commentCount: 0, votes: {} });
            }
            const data = doc.data() || { likes: 0, dislikes: 0, commentCount: 0, votes: {} };
            const votes = data.votes || {};
            const currentVote = votes[currentUser.uid];

            let newLikes = data.likes || 0;
            let newDislikes = data.dislikes || 0;

            if (currentVote === type) {
                if (type === 'like') newLikes--; else newDislikes--;
                delete votes[currentUser.uid];
            } else {
                if (currentVote === 'like') newLikes--;
                if (currentVote === 'dislike') newDislikes--;
                if (type === 'like') newLikes++; else newDislikes++;
                votes[currentUser.uid] = type;
            }
            transaction.update(docRef, { likes: newLikes, dislikes: newDislikes, votes: votes });
        });
    }

    let activeCommentDay = 0;
    function openComments(dayIdx) { activeCommentDay = dayIdx; document.getElementById('commentModal').style.display = 'flex'; loadComments(dayIdx); }
    function closeComments() { document.getElementById('commentModal').style.display = 'none'; }
    
    function loadComments(dayIdx) {
        const list = document.getElementById('commentList'); list.innerHTML = '<div style="text-align:center; color:#888; margin-top:20px;">Yükleniyor...</div>';
        if(!db) { list.innerHTML = '<div style="text-align:center; color:#888;">Bağlantı yok.</div>'; return; }
        const docId = `${currentMeal}_nov_${dayIdx}`;
        db.collection('comments').where('docId', '==', docId).onSnapshot(snapshot => {
            list.innerHTML = ''; if(snapshot.empty) { list.innerHTML = '<div style="text-align:center; color:#888;">Henüz yorum yok.</div>'; return; }
            let comments = []; snapshot.forEach(doc => comments.push(doc.data()));
            comments.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            
            // Yorum Sayacı Güncelleme
            db.collection('daily_stats').doc(docId).set({ commentCount: snapshot.size }, { merge: true });

            comments.forEach(c => { 
                // Avatar varsa göster, yoksa baş harf
                let avatarHtml = `<div class="c-avatar" style="display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;">${c.userName.charAt(0).toUpperCase()}</div>`;
                // Eğer user photosu kaydettiysek (daha ileri seviye) buraya eklenebilir. Şimdilik basit tuttum.
                
                list.innerHTML += `
                <div class="single-comment">
                    ${avatarHtml}
                    <div class="c-content">
                        <div class="c-user">${c.userName}</div>
                        <div class="c-text">${c.text}</div>
                    </div>
                </div>`; 
            });
        });
    }

    function postComment() {
        if(!currentUser) return alert("Giriş yapmalısınız.");
        const input = document.getElementById('commentInput'); const text = input.value.trim(); if(!text) return;
        const docId = `${currentMeal}_nov_${activeCommentDay}`;
        db.collection('comments').add({ docId: docId, text: text, userId: currentUser.uid, userName: currentUser.displayName, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        input.value = '';
    }
</script>

</body>
</html>
