<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KYK Yemek - Aralık Menüsü</title>
    
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/freddiechill/gorsel-depom/refs/heads/main/kykyemek_20251122_043032_0000.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/freddiechill/gorsel-depom/refs/heads/main/kykyemek_20251122_043032_0000.png">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@700,900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* --- TEMEL AYARLAR --- */
        * { 
            -webkit-tap-highlight-color: transparent; 
            outline: none; 
            scrollbar-width: none;
            -ms-overflow-style: none;
            box-sizing: border-box;
        }
        ::-webkit-scrollbar { display: none; }

        body {
            font-family: 'Satoshi', sans-serif; font-weight: 700; background-color: #121212; color: #e0e0e0;
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: background-color 0.3s; -webkit-user-select: none; user-select: none;
        }

        /* --- ANİMASYONLAR --- */
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideDown { from { transform: translateY(0); opacity: 1; } to { transform: translateY(100%); opacity: 0; } }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes zoomOut { from { transform: scale(1); opacity: 1; } to { transform: scale(0.9); opacity: 0; } }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        
        /* Kırmızı Yanıp Sönme Animasyonu */
        @keyframes flashRed { 
            0% { background-color: rgba(239, 83, 80, 0.6); border-color: #ef5350; } 
            50% { background-color: rgba(239, 83, 80, 0.3); }
            100% { background-color: #252525; border-color: #333; } 
        }
        @keyframes highlightRow { 0% { background-color: rgba(255, 215, 0, 0.4); } 100% { background-color: transparent; } }

        .anim-slide-up { animation: slideUp 0.4s cubic-bezier(0.2, 1, 0.3, 1) forwards; }
        .anim-slide-down { animation: slideDown 0.4s cubic-bezier(0.2, 1, 0.3, 1) forwards; }
        .anim-zoom-in { animation: zoomIn 0.3s ease-out forwards; }
        .anim-zoom-out { animation: zoomOut 0.3s ease-in forwards; }
        .anim-pop { animation: pop 0.3s ease-out; }
        .row-highlight { animation: highlightRow 2s ease-out forwards; }

        /* --- ÜST BAR --- */
        #auth-container { 
            position: absolute; top: 20px; right: 20px; z-index: 6000; 
            display: flex; align-items: center; gap: 12px;
        }

        .notif-btn {
            position: relative; width: 40px; height: 40px; 
            background: rgba(255,255,255,0.1); border-radius: 50%; 
            display: none; 
            align-items: center; justify-content: center; 
            cursor: pointer; color: #fff;
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.2s;
        }
        .notif-btn:active { transform: scale(0.9); }
        .notif-btn svg { width: 22px; height: 22px; fill: currentColor; }
        
        /* Ana Sayfa Kupa İkonu */
        #leaderboardBtn svg { width: 24px; height: 24px; fill: #e3e3e3; } 

        .notif-badge {
            position: absolute; top: -2px; right: -2px; 
            width: 10px; height: 10px; background-color: #ef5350; 
            border-radius: 50%; border: 2px solid #121212; 
            display: none;
        }

        /* SADE PROFİL BUTONU */
        .login-btn {
            background: transparent; padding: 0; border: 2px solid #fff;
            width: 42px; height: 42px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.2s; overflow: hidden;
        }
        .login-btn.text-mode { 
            width: auto; height: 38px; padding: 0 15px; 
            background: #fff; color: #333; border: none; border-radius: 20px;
            font-weight: 900; font-size: 0.85rem; font-family: 'Satoshi', sans-serif;
        }
        
        .login-btn:active { transform: scale(0.95); }
        .user-avatar { width: 100%; height: 100%; object-fit: cover; display: flex; align-items: center; justify-content: center; background: #ccc; color: #555; font-size: 14px;}

        /* --- MODALLER --- */
        .modal-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); z-index: 7000; align-items: center; justify-content: center;
        }
        
        #adminModal, #historyModal { z-index: 8000; }

        .auth-box { 
            background: #1e1e1e; padding: 25px; border-radius: 20px; width: 90%; max-width: 350px; 
            border: 1px solid #333; text-align: center; position: relative; 
        }

        #notificationModal .auth-box, #leaderboardModal .auth-box, #historyModal .auth-box { 
            max-width: 380px; height: 60vh; display: flex; flex-direction: column; padding: 0; overflow: hidden;
        }

        #adminModal .auth-box, #profileModal .auth-box {
            max-width: 380px; height: auto; max-height: 80vh; 
            display: flex; flex-direction: column; padding: 20px; overflow: hidden;
        }

        #fullListModal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 9000; padding: 20px; padding-top: 80px; 
            background: #121212; box-sizing: border-box; flex-direction: column;
        }

        .notif-header { padding: 15px; border-bottom: 1px solid #333; font-size: 1.1rem; font-weight: bold; text-align: center; background: #222; width: 100%; box-sizing: border-box;}
        
        #adminModal .notif-header, #profileModal .header-bar {
            background: transparent; border-bottom: 1px solid #333; 
            margin-bottom: 20px; padding: 10px 0 15px 0; min-height: 40px;
            display: flex; justify-content: center; align-items: center; position: relative;
        }
        
        .header-title { font-size: 1.2rem; color: #fff; font-weight: bold; }
        
        .header-icon-right { position: absolute; right: 0; top: 0; color: #888; cursor: pointer; padding: 5px; transition: color 0.2s; }
        .header-icon-right:hover { color: #fff; }

        .notif-list { flex: 1; overflow-y: auto; padding: 0; margin: 0; list-style: none; width: 100%; }
        .notif-item { padding: 15px; border-bottom: 1px solid #333; cursor: pointer; display: flex; flex-direction: column; gap: 5px; background: #1e1e1e; transition: background 0.2s; text-align: left; }
        .notif-item:hover { background: #252525; }
        .notif-item.unread { background: #2a1a1a; border-left: 4px solid #ef5350; }
        .notif-text { font-size: 0.9rem; color: #ddd; line-height: 1.4; }
        .notif-text b { color: #fff; }
        .notif-time { font-size: 0.75rem; color: #888; align-self: flex-end; }
        .notif-empty { padding: 20px; text-align: center; color: #888; }

        /* --- LEADERBOARD --- */
        .lb-item { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #333; transition: background 0.3s; }
        .lb-rank { font-size: 1.1rem; font-weight: 900; width: 30px; text-align: center; color: #666; }
        .lb-rank.top1 { color: #FFD700; }
        .lb-rank.top2 { color: #C0C0C0; }
        .lb-rank.top3 { color: #CD7F32; }
        .lb-user { flex: 1; display: flex; align-items: center; gap: 10px; overflow: hidden; margin-left: 5px; }
        .lb-avatar { width: 34px; height: 34px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 1px solid #444; }
        .lb-name { font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #e0e0e0; }
        .lb-score { font-size: 0.9rem; font-weight: bold; color: #ef5350; display: flex; align-items: center; gap: 4px; }
        .lb-score svg { width: 14px; height: 14px; fill: currentColor; }
        .lb-self { background: rgba(255, 235, 59, 0.1); border-left: 3px solid #ffeb3b; }

        /* --- COMMENT HISTORY --- */
        .hist-item { padding: 15px; border-bottom: 1px solid #333; cursor: pointer; text-align: left; transition: background 0.2s; }
        .hist-item:hover { background: #252525; }
        .hist-text { font-size: 0.95rem; color: #eee; margin-bottom: 6px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4; }
        .hist-meta { font-size: 0.75rem; color: #888; display: flex; justify-content: space-between; text-transform: uppercase; font-weight: bold; letter-spacing: 0.5px; }

        /* --- ADMIN / USER INFO PANEL --- */
        .admin-content { padding: 5px; display: flex; flex-direction: column; align-items: center; width: 100%; box-sizing: border-box; overflow-y: auto; position: relative; }
        #adminMainActions { display: flex; gap: 15px; justify-content: center; margin-top: 10px; width: 100%; }
        .admin-btn { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: 900; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; color: #121212; font-family: 'Satoshi', sans-serif; transition: transform 0.2s; }
        .admin-btn:active { transform: scale(0.95); }
        .restrict-btn { background: #fff59d; }
        .ban-btn { background: #ef9a9a; }
        .unban-btn { background: #a5d6a7; width: 100%; } 
        .admin-btn svg { width: 24px; height: 24px; fill: #121212; }
        .history-title { width: 100%; text-align: left; color: #888; font-size: 0.8rem; margin-top: 20px; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px; }
        .history-item { width: 100%; display: flex; justify-content: space-between; font-size: 0.85rem; padding: 8px 0; border-bottom: 1px solid #222; }
        .h-action { font-weight: bold; }
        .h-action.banned { color: #ef9a9a; }
        .h-action.restricted { color: #fff59d; }
        .h-action.unbanned { color: #a5d6a7; }
        .h-date { color: #666; font-size: 0.75rem; }
        
        .user-info-text { color: #888; font-size: 0.8rem; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 1px; }
        .user-info-val { color: #fff; font-size: 1rem; font-weight: bold; margin-bottom: 15px; text-align: center; line-height: 1.3; }

        /* KULLANICI KARTI BUTONLARI */
        .user-rank-btn { 
            position: absolute; left: 10px; top: 8px; 
            width: 32px; height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 20;
        }
        .user-rank-btn svg { width: 20px; height: 20px; fill: #e3e3e3; } 

        .user-like-wrapper { 
            position: absolute; right: 10px; top: 8px;
            width: 32px; height: auto; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            cursor: pointer; z-index: 20;
        }
        .user-like-btn-circle {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .user-like-btn-circle.is-liked { background: rgba(239,83,80,0.2); border-color: #ef5350; color: #ef5350; }
        .user-like-btn-circle svg { width: 16px; height: 16px; fill: currentColor; color: #555; }
        .user-like-btn-circle.is-liked svg { color: #ef5350; }
        .user-like-count { font-family: 'Satoshi', sans-serif; font-size: 0.7rem; font-weight: 900; color: #ccc; margin-top: 2px; }

        /* --- CARD & CAROUSEL --- */
        .header-container { position: relative; width: 100%; text-align: center; z-index: 10; pointer-events: none; margin-top: 60px; margin-bottom: 10px;}
        .date-display { font-size: 1.4rem; color: #fff; margin-top: 5px; text-shadow: 0 4px 12px rgba(0,0,0,0.5); transition: opacity 0.2s; }
        
        .left-controls { position: absolute; top: 20px; left: 20px; z-index: 9500; }
        
        .icon-btn { background: rgba(30, 30, 30, 0.6); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.1); border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: transform 0.2s; }
        .icon-btn:active { transform: scale(0.9); background: #333; }
        .icon-btn svg { width: 24px; height: 24px; fill: currentColor; pointer-events: none; display: block; }

        .carousel-container { position: relative; width: 100%; height: 65vh; perspective: 1000px; display: flex; align-items: center; justify-content: center; touch-action: pan-y; }
        .menu-card { position: absolute; top: 50%; left: 50%; width: 85%; max-width: 380px; height: auto; max-height: 60vh; background: #1e1e1e; border-radius: 24px; border: 2px solid #333; box-shadow: 0 15px 40px rgba(0,0,0,0.6); display: flex; flex-direction: column; overflow: hidden; transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.4s, border-color 0.3s; padding-bottom: 10px; }
        .pos-2 { z-index: 30; transform: translate(-50%, -50%) scale(1); opacity: 1; }
        .pos-1 { z-index: 20; transform: translate(-85%, -50%) scale(0.85); opacity: 0.5; pointer-events: none; }
        .pos-3 { z-index: 20; transform: translate(-15%, -50%) scale(0.85); opacity: 0.5; pointer-events: none; }
        .pos-0 { z-index: 10; transform: translate(-150%, -50%) scale(0.7); opacity: 0; }
        .pos-4 { z-index: 10; transform: translate(50%, -50%) scale(0.7); opacity: 0; }

        .card-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: rgba(255,255,255,0.03); border-bottom: 1px solid #333; min-height: 50px; flex-shrink: 0; }
        .meal-title { font-size: 1.2rem; font-weight: 900; text-transform: uppercase; }
        .switch-btn { background: #333; color: #fff; border: none; padding: 6px 12px; border-radius: 20px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 5px; font-family: 'Satoshi', sans-serif; font-size: 0.8rem; }
        .pos-2 .switch-btn { opacity: 1; pointer-events: auto; }

        ul { list-style: none; padding: 10px 0; margin: 0; overflow-y: auto; flex: 1; }
        li { padding: 12px 20px; border-bottom: 1px solid #2c2c2c; font-size: 1.05rem; text-align: center; color: #ddd; }
        li:last-child { border-bottom: none; }

        .social-footer { display: flex; justify-content: space-around; align-items: center; padding: 15px 10px; background: #151515; border-top: 1px solid #333; flex-shrink: 0; }
        .social-action { display: flex; flex-direction: column; align-items: center; color: #888; cursor: pointer; transition: color 0.2s; position: relative; width: 60px; flex-shrink: 0; }
        .social-action:active { transform: scale(0.9); }
        .social-action svg { width: 28px; height: 28px; fill: currentColor; display: block; margin-bottom: 4px; }
        .flip-icon { transform: scaleY(-1); }
        .count-text { font-size: 0.8rem; font-weight: bold; font-variant-numeric: tabular-nums; }
        .liked { color: #a5d6a7 !important; } .disliked { color: #ef9a9a !important; }

        .nav-btn { position: absolute; top: 50%; transform: translateY(-50%); width: 80px; height: 80vh; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100; background: transparent; border: none; color: rgba(255,255,255,0.3); }
        .nav-left { left: 0; justify-content: flex-start; padding-left: 10px; }
        .nav-right { right: 0; justify-content: flex-end; padding-right: 10px; }

        body.theme-breakfast .menu-card { border-color: #fff59d; } body.theme-breakfast .meal-title { color: #fff59d; } body.theme-breakfast .switch-btn { background: #fff59d; color: #121212; }
        body.theme-dinner .menu-card { border-color: #ef9a9a; } body.theme-dinner .meal-title { color: #ef9a9a; } body.theme-dinner .switch-btn { background: #ef9a9a; color: #121212; }

        /* --- AUTH FORMS --- */
        .auth-tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #333; }
        .auth-tab { flex: 1; padding: 10px; cursor: pointer; color: #888; font-weight: bold; transition: 0.3s; }
        .auth-tab.active { color: #fff; border-bottom: 2px solid #fff; }
        .auth-input, .auth-select { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 10px; border: 1px solid #444; background: #252525; color: #fff; box-sizing: border-box; font-family: 'Satoshi', sans-serif; outline: none; }
        .auth-select { appearance: none; -webkit-appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto; }
        
        .auth-submit { width: 100%; padding: 12px; border-radius: 10px; border: none; background: #fff; color: #000; font-weight: 900; cursor: pointer; font-family: 'Satoshi', sans-serif; transition: transform 0.2s; }
        .auth-submit:active { transform: scale(0.95); }
        .auth-close { margin-top: 15px; color: #888; cursor: pointer; font-size: 0.9rem; display: block; }

        .avatar-upload { 
            width: 90px; 
            height: 90px;
            min-width: 90px;
            min-height: 90px;
            border-radius: 50%; 
            background: #333; 
            margin: 0 auto 15px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            overflow: hidden; 
            border: 2px dashed #555; 
            position: relative; 
            flex-shrink: 0;
        }
        .avatar-upload img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .avatar-upload span { font-size: 0.8rem; color: #888; }
        #fileInput, #profileFileInput { display: none; }

        /* --- YORUMLAR --- */
        .comment-modal { display: none; position: fixed; background: #121212; box-sizing: border-box; flex-direction: column; bottom: 0; left: 0; width: 100%; height: 70vh; border-radius: 24px 24px 0 0; z-index: 7000; padding: 20px; box-shadow: 0 -10px 30px rgba(0,0,0,0.7); }
        .modal-header { display: flex; justify-content: center; align-items: center; margin-bottom: 15px; color:#fff; font-size:1.2rem; font-weight: bold; position: relative; min-height: 32px; }
        .close-modal-btn { position: absolute; right: 0; top: 0; font-size: 24px; color: #fff; cursor: pointer; width: 32px; height: 32px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; line-height: 1; }
        
        .comment-list { flex: 1; overflow-y: auto; margin-bottom: 10px; }
        .modal-scroll-area { flex: 1; overflow-y: auto; margin-bottom: 10px; }
        
        .single-comment { background: #252525; padding: 12px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #333; display: flex; flex-direction: column; gap: 8px; position: relative; max-width: 100%; box-sizing: border-box; overflow-wrap: anywhere; word-break: break-word; transition: background 0.5s ease, border-color 0.5s ease; }
        .highlight-comment { animation: flashRed 2s ease-out forwards; }
        
        .reply-comment { margin-left: 35px; background: #1a1a1a; border-left: 2px solid #444; width: calc(100% - 35px); }
        .reply-icon { position: absolute; left: -22px; top: 15px; width: 14px; height: 14px; fill: #777; }
        
        .c-top { display: flex; gap: 10px; width: 100%; }
        .c-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; flex-shrink: 0; background: #444; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; font-size: 14px; cursor: pointer;}
        .c-content { flex: 1; min-width: 0; }
        .c-user { font-size: 0.85rem; color: #ccc; font-weight: bold; margin-bottom: 2px; display: flex; align-items: center; gap: 5px; cursor: pointer; } 
        .c-text { font-size: 0.95rem; color: #fff; line-height: 1.4; }
        .badge-icon { width: auto; height: 10px; vertical-align: middle; margin-left: 2px; }
        .mention-text { color: #90caf9; font-weight: bold; margin-right: 5px; }
        .c-actions { display: flex; gap: 15px; margin-left: 46px; align-items: center; }
        .c-action-btn { display: flex; align-items: center; gap: 4px; color: #777; cursor: pointer; font-size: 0.75rem; font-weight: bold; transition: color 0.2s; }
        .c-action-btn svg { width: 16px; height: 16px; fill: currentColor; display: block; }
        .c-action-btn:hover { color: #fff; }
        .c-action-btn.c-liked { color: #a5d6a7; }
        .c-action-btn.c-disliked { color: #ef9a9a; }
        .reply-trigger { color: #aaa; font-size: 0.75rem; cursor: pointer; margin-left: auto; margin-right: 5px; font-weight: bold; }
        .reply-trigger:hover { color: #fff; }

        .reply-input-wrapper { display: none; margin-left: 46px; margin-top: 5px; gap: 5px; width: calc(100% - 46px); box-sizing: border-box; }
        
        .reply-input { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #444; background: #121212; color: #fff; font-family: 'Satoshi', sans-serif; font-size: 0.9rem; outline: none; min-width: 0; }
        .reply-send-btn { background: #ef9a9a; border: none; width: 40px; height: 36px; border-radius: 8px; cursor: pointer; color: #121212; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .reply-send-btn svg { width: 20px; height: 20px; fill: currentColor; }
        .time-ago { position: absolute; top: 10px; right: 10px; font-size: 0.7rem; color: #666; font-weight: 500; }
        .single-comment.has-delete .time-ago { right: 32px; }
        .delete-comment-btn { position: absolute; top: 9px; right: 10px; color: #ef5350; cursor: pointer; font-size: 14px; opacity: 0.7; transition: opacity 0.2s; z-index: 5; display: flex; align-items: center; justify-content: center; }
        .delete-comment-btn:hover { opacity: 1; transform: scale(1.1); }
        .delete-comment-btn svg { width: 14px; height: 14px; fill: currentColor; }
        .comment-input-area { display: flex; gap: 10px; }
        .comment-input { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #444; background: #121212; color: #fff; font-family: 'Satoshi', sans-serif; outline: none;}
        .send-btn { background: #ef9a9a; border: none; padding: 0 20px; border-radius: 10px; font-weight: bold; cursor: pointer; color: #121212; font-family: 'Satoshi', sans-serif; display: flex; align-items: center; justify-content: center;}
        .send-btn svg { width: 24px; height: 24px; fill: currentColor; }
        
        .day-row { background: #1e1e1e; margin-bottom: 15px; border-radius: 10px; padding: 15px; border: 1px solid #333; }
        .day-header { font-size: 1.1rem; color: #888; margin-bottom: 10px; text-align: center; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .day-content { font-size: 1rem; line-height: 1.6; text-align: center; color: #e0e0e0; white-space: pre-line; }
        .modal-toggle-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .modal-toggle { padding: 10px 20px; border-radius: 10px; border: 1px solid #444; background: #1e1e1e; color: #888; font-family: 'Satoshi', sans-serif; font-weight: 700; cursor: pointer; }
        .modal-toggle.active-yellow { background: #fff59d; color: #121212; border-color: #fff59d; }
        .modal-toggle.active-red { background: #ef9a9a; color: #121212; border-color: #ef9a9a; }

        @media (min-width: 768px) {
            .menu-card { max-width: 400px; max-height: 60vh; }
            .nav-btn { width: 120px; }
        }
    </style>
</head>
<body class="theme-dinner">

    <div class="left-controls">
        <button class="icon-btn" onclick="toggleModal()" title="Tüm Liste">
            <svg id="icon-eye" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            <svg id="icon-eye-off" viewBox="0 0 24 24" style="display: none;">
                <path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.44-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46A11.804 11.804 0 0 0 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2z"/>
            </svg>
        </button>
    </div>

    <div id="auth-container">
        <div class="notif-btn" id="leaderboardBtn" style="display:none;" onclick="openLeaderboard()">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M280-120v-80h160v-124q-49-11-87.5-41.5T296-442q-75-9-125.5-65.5T120-640v-40q0-33 23.5-56.5T200-760h80v-80h400v80h80q33 0 56.5 23.5T840-680v40q0 76-50.5 132.5T664-442q-18 46-56.5 76.5T520-324v124h160v80H280Zm0-408v-152h-80v40q0 38 22 68.5t58 43.5Zm200 128q50 0 85-35t35-85v-240H360v240q0 50 35 85t85 35Zm200-128q36-13 58-43.5t22-68.5v-40h-80v152Zm-200-52Z"/></svg>
        </div>
        <div class="notif-btn" id="mainNotifBtn" style="display:none;" onclick="showNotifications()">
            <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg>
            <div id="notifBadge" class="notif-badge"></div>
        </div>
        <div id="loginBtnArea"><button class="login-btn text-mode" onclick="openAuthModal()">Giriş Yap</button></div>
    </div>

    <div class="header-container">
        <div class="date-display" id="currentDate">Yükleniyor...</div>
    </div>

    <div class="carousel-container" id="carouselTouchArea">
        <button class="nav-btn nav-left" onclick="moveCarousel(-1)"><svg viewBox="0 0 24 24" width="30" height="30" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg></button>
        <button class="nav-btn nav-right" onclick="moveCarousel(1)"><svg viewBox="0 0 24 24" width="30" height="30" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></button>
        <div class="menu-card" id="c0"></div>
        <div class="menu-card" id="c1"></div>
        <div class="menu-card" id="c2"></div>
        <div class="menu-card" id="c3"></div>
        <div class="menu-card" id="c4"></div>
    </div>

    <div id="authModal" class="modal-overlay">
        <div class="auth-box anim-zoom-in">
            <div class="auth-tabs" id="authTabs">
                <div class="auth-tab active" onclick="switchAuthTab('login')">Giriş Yap</div>
                <div class="auth-tab" onclick="switchAuthTab('register')">Kayıt Ol</div>
            </div>
            <div id="loginForm">
                <input type="email" id="loginEmail" class="auth-input" placeholder="E-posta">
                <input type="password" id="loginPass" class="auth-input" placeholder="Şifre">
                <button class="auth-submit" onclick="loginUser()">GİRİŞ YAP</button>
            </div>
            <div id="registerForm" style="display:none;">
                <div class="avatar-upload" onclick="document.getElementById('fileInput').click()">
                    <span id="avatarLabel">Foto Seç</span>
                    <img id="avatarPreview">
                </div>
                <input type="file" id="fileInput" accept="image/*" onchange="handleAvatarSelect(this)">
                <input type="text" id="regNick" class="auth-input" placeholder="Kullanıcı Adı (Nick)">
                <input type="email" id="regEmail" class="auth-input" placeholder="E-posta">
                
                <select id="regUni" class="auth-select" onchange="updateDeptOptions('regUni', 'regDept')">
                    <option value="">Üniversite Seç</option>
                    <option value="SAÜ">Sakarya Üniversitesi</option>
                    <option value="SUBÜ">Sakarya Uygulamalı Bilimler Üniversitesi</option>
                </select>
                <select id="regDept" class="auth-select">
                    <option value="">Önce Üniversite Seçin</option>
                </select>

                <input type="password" id="regPass" class="auth-input" placeholder="Şifre (En az 6 karakter)">
                <button class="auth-submit" onclick="startRegistration()">KAYIT OL</button>
            </div>
            <span class="auth-close" onclick="closeAuthModal()">Kapat</span>
        </div>
    </div>

    <div id="profileModal" class="modal-overlay">
        <div class="auth-box anim-zoom-in">
            <div class="header-bar">
                <span class="header-title">Profil Ayarları</span>
                <div class="header-icon-right" onclick="openCommentHistory()" title="Geçmiş">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
                </div>
            </div>

            <div class="avatar-upload" onclick="document.getElementById('profileFileInput').click()">
                <img id="profileAvatarPreview" style="display:block;">
            </div>
            <input type="file" id="profileFileInput" accept="image/*" onchange="handleProfileAvatarSelect(this)">
            <input type="text" id="profileNick" class="auth-input" placeholder="Yeni Nick">

            <select id="profileUni" class="auth-select" onchange="updateDeptOptions('profileUni', 'profileDept')">
                <option value="">Üniversite Seç</option>
                <option value="SAÜ">Sakarya Üniversitesi</option>
                <option value="SUBÜ">Sakarya Uygulamalı Bilimler Üniversitesi</option>
            </select>
            <select id="profileDept" class="auth-select">
                <option value="">Önce Üniversite Seçin</option>
            </select>

            <button class="auth-submit" onclick="saveProfile()" style="margin-bottom:10px;">KAYDET</button>
            <button class="auth-submit" onclick="logoutUser()" style="background:#ef5350; color:#fff;">ÇIKIŞ YAP</button>
            <span class="auth-close" onclick="closeProfileModal()">Kapat</span>
        </div>
    </div>

    <div id="historyModal" class="modal-overlay">
        <div class="auth-box anim-zoom-in">
            <div class="notif-header">Yorum Geçmişi</div>
            <div class="notif-list" id="historyList">Yükleniyor...</div>
            <span class="auth-close" onclick="closeHistoryModal()">Kapat</span>
        </div>
    </div>

    <div id="notificationModal" class="modal-overlay">
        <div class="auth-box anim-zoom-in">
            <div class="notif-header">Bildirimler</div>
            <div class="notif-list" id="notificationList"></div>
            <span class="auth-close" onclick="closeNotificationModal()">Kapat</span>
        </div>
    </div>

    <div id="leaderboardModal" class="modal-overlay">
        <div class="auth-box anim-zoom-in">
            <div class="notif-header">En Çok Beğenilenler</div>
            <div class="notif-list" id="leaderboardList">Yükleniyor...</div>
            <span class="auth-close" onclick="closeLeaderboardModal()">Kapat</span>
        </div>
    </div>
    
    <div id="adminModal" class="modal-overlay">
        <div class="auth-box anim-zoom-in">
            <div class="notif-header">Kullanıcı Bilgileri</div>
            
            <div class="user-rank-btn" onclick="goToLeaderboardRank()">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M280-120v-80h160v-124q-49-11-87.5-41.5T296-442q-75-9-125.5-65.5T120-640v-40q0-33 23.5-56.5T200-760h80v-80h400v80h80q33 0 56.5 23.5T840-680v40q0 76-50.5 132.5T664-442q-18 46-56.5 76.5T520-324v124h160v80H280Zm0-408v-152h-80v40q0 38 22 68.5t58 43.5Zm200 128q50 0 85-35t35-85v-240H360v240q0 50 35 85t85 35Zm200-128q36-13 58-43.5t22-68.5v-40h-80v152Zm-200-52Z"/></svg>
            </div>

            <div class="user-like-wrapper" onclick="toggleProfileLike()">
                <div class="user-like-btn-circle" id="likeIconTarget">
                    <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                </div>
                <div class="user-like-count" id="profileLikeCount">0</div>
            </div>

            <div class="admin-content">
                <div class="avatar-upload" style="border-color: #ffd700; width:60px; height:60px; margin-bottom:10px; flex-shrink: 0;">
                     <img id="adminUserImg" style="display:block; width:100%; height:100%; object-fit:cover;">
                </div>
                <h3 id="adminUserName" style="color:#fff; margin: 0 0 15px 0;"></h3>
                
                <div class="user-info-text">Üniversite</div>
                <div class="user-info-val" id="adminUserUni">...</div>
                <div class="user-info-text">Bölüm</div>
                <div class="user-info-val" id="adminUserDept">...</div>

                <div id="adminToolsArea" style="display:none; width:100%;">
                    <div id="adminMainActions">
                        <button class="admin-btn unban-btn" id="btnLiftBan" style="display:none;" onclick="liftBan()">
                            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                            Yasağı Kaldır
                        </button>
                        <div id="btnGroupRestrict" style="display:flex; gap:15px; width:100%;">
                            <button class="admin-btn restrict-btn" onclick="showDurationOptions()">
                                <svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
                                Kısıtla
                            </button>
                            <button class="admin-btn ban-btn" onclick="confirmBan()">
                                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11H7v-2h10v2z"/></svg>
                                Banla
                            </button>
                        </div>
                    </div>

                    <div id="adminDurationOptions" style="display:none; flex-direction:column; gap:5px; margin-top:15px; width:100%;">
                        <button class="auth-submit" onclick="applyRestriction(1, 'saat')">1 Saat</button>
                        <button class="auth-submit" onclick="applyRestriction(24, 'saat')">1 Gün</button>
                        <button class="auth-submit" onclick="applyRestriction(7, 'gün')">1 Hafta</button>
                        <button class="auth-submit" onclick="applyRestriction(30, 'gün')">1 Ay</button>
                        <button class="auth-submit" onclick="applyRestriction(365, 'gün')">1 Yıl</button>
                        <span class="auth-close" onclick="hideDurationOptions()" style="margin-top:10px;">Geri</span>
                    </div>

                    <div class="history-title">İŞLEM GEÇMİŞİ</div>
                    <div id="adminBanHistory" style="width:100%; max-height:150px; overflow-y:auto;"></div>
                </div>

            </div>
            <span class="auth-close" onclick="closeAdminModal()">Kapat</span>
        </div>
    </div>

    <div id="commentModal" class="comment-modal anim-slide-up">
        <div class="modal-header">
            <span>Yorumlar</span>
            <div class="close-modal-btn" onclick="closeComments()">&times;</div>
        </div>
        <div class="comment-list" id="commentList"></div>
        <div class="comment-input-area">
            <input type="text" id="commentInput" class="comment-input" placeholder="Bir şeyler yaz...">
            <button class="send-btn" onclick="postComment()">
                <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </div>
    </div>

    <div id="fullListModal" class="anim-slide-up">
        <div class="modal-header">
            <span>Tüm Ayın Listesi</span>
        </div>
        <div class="modal-toggle-container">
            <button class="modal-toggle" id="modalBtnBreakfast" onclick="renderFullList('breakfast')">Kahvaltı</button>
            <button class="modal-toggle" id="modalBtnDinner" onclick="renderFullList('dinner')">Akşam</button>
        </div>
        <div class="modal-scroll-area" id="fullListContainer"></div>
    </div>

<script>
    const CURRENT_MONTH_TAG = "dec"; // Aralık ayı etiketi. Gelecek ay burayı 'jan' yapman yeterli.

    const firebaseConfig = {
        apiKey: "AIzaSyDhYvJ6v8F9e7PsdkY7VXGjQW2iTUbVHQY",
        authDomain: "kyk-yemek-app.firebaseapp.com",
        projectId: "kyk-yemek-app",
        storageBucket: "kyk-yemek-app.firebasestorage.app",
        messagingSenderId: "177253204360",
        appId: "1:177253204360:web:0b0516ad80df3e5658fa3d",
        measurementId: "G-EGGGN0B9J5"
    };

    let db, auth;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();
    } catch (e) { console.log(e); }

    let currentUser = null, currentUserAvatar = null, selectedAvatarBase64 = null, profileAvatarBase64 = null;
    let scrollTargetId = null;
    let currentUserStatus = { banned: false, restrictedUntil: null };
    let selectedTargetUser = null; 
    let notificationUnsubscribe = null;

    const uniData = {
        "SAÜ": [
            "Alman Dili ve Edebiyatı", "Almanca Mütercim ve Tercümanlık", "Bilgisayar Mühendisliği", "Bilişim Sistemleri Mühendisliği", 
            "Bilişim Sistemleri ve Teknolojileri", "Biyoloji", "Coğrafya", "Çalışma Ekonomisi ve Endüstri İlişkileri", "Çevre Mühendisliği", 
            "Diş Hekimliği", "Ebelik", "Ekonometri", "Elektrik-Elektronik Mühendisliği", "Endüstri Mühendisliği", "Felsefe", 
            "Fen Bilgisi Öğretmenliği", "Fizik", "Gazetecilik", "Gıda Mühendisliği", "Görsel İletişim Tasarımı", "Halkla İlişkiler ve Reklamcılık", 
            "Hemşirelik", "Hukuk", "İktisat", "İlahiyat", "İlahiyat (M.T.O.K.)", "İlköğretim Matematik Öğretmenliği", "İngilizce Mütercim ve Tercümanlık", 
            "İngilizce Öğretmenliği (İngilizce)", "İnsan Kaynakları Yönetimi", "İnşaat Mühendisliği", "İslam İktisadı ve Finans", "İşletme", 
            "İşletme (İngilizce)", "Kimya", "Makine Mühendisliği", "Maliye", "Matematik", "Metalurji ve Malzeme Mühendisliği", 
            "Metalurji ve Malzeme Mühendisliği (İngilizce)", "Mimarlık", "Okul Öncesi Öğretmenliği", "Özel Eğitim Öğretmenliği", "Psikoloji", 
            "Radyo, Televizyon ve Sinema", "Rehberlik ve Psikolojik Danışmanlık", "Sağlık Yönetimi", "Sanat Tarihi", "Sınıf Öğretmenliği", 
            "Siber Güvenlik Mühendisliği", "Siyaset Bilimi ve Kamu Yönetimi", "Sosyal Bilgiler Öğretmenliği", "Sosyal Hizmet", "Sosyoloji", 
            "Tarih", "Tıp", "Türk Dili ve Edebiyatı", "Türkçe Öğretmenliği", "Uluslararası İlişkiler", "Uluslararası Ticaret ve Lojistik", 
            "Veri Bilimi ve Analitiği", "Yazılım Mühendisliği (İngilizce)", "Yazılım Mühendisliği (İngilizce) (KKTC Uyruklu)", 
            "Yeni Medya ve İletişim", "Yönetim Bilişim Sistemleri"
        ],
        "SUBÜ": [
            "Bahçe Bitkileri", "Bilgisayar Mühendisliği", "Bilgisayar Mühendisliği (M.T.O.K.)", "Bitki Koruma", "Elektrik-Elektronik Mühendisliği", 
            "Elektrik-Elektronik Mühendisliği (M.T.O.K.)", "Finans ve Bankacılık", "Fizyoterapi ve Rehabilitasyon", "Gastronomi ve Mutfak Sanatları", 
            "Hemşirelik", "İnşaat Mühendisliği", "Makine Mühendisliği", "Makine Mühendisliği (M.T.O.K.)", "Mekatronik Mühendisliği", 
            "Mekatronik Mühendisliği (KKTC Uyruklu)", "Mekatronik Mühendisliği (M.T.O.K.)", "Metalurji ve Malzeme Mühendisliği", 
            "Peyzaj Mimarlığı", "Rekreasyon Yönetimi", "Sağlık Yönetimi", "Spor Yöneticiliği", "Tarla Bitkileri", "Turizm İşletmeciliği", 
            "Turizm Rehberliği", "Uluslararası Ticaret ve Finansman", "Uluslararası Ticaret ve Lojistik"
        ]
    };

    function updateDeptOptions(uniSelectId, deptSelectId) {
        const uniSelect = document.getElementById(uniSelectId);
        const deptSelect = document.getElementById(deptSelectId);
        const selectedUni = uniSelect.value;
        deptSelect.innerHTML = '<option value="">Bölüm Seç</option>';
        if(selectedUni && uniData[selectedUni]) {
            uniData[selectedUni].forEach(dept => {
                const opt = document.createElement('option'); opt.value = dept; opt.innerText = dept; deptSelect.appendChild(opt);
            });
        } else { deptSelect.innerHTML = '<option value="">Önce Üniversite Seçin</option>'; }
    }

    const CHECK_VERIFICATION_DATE = new Date("2025-11-25T00:00:00").getTime();

    if(auth) {
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const createdTime = new Date(user.metadata.creationTime).getTime();
                const isLegacyUser = createdTime < CHECK_VERIFICATION_DATE;
                if (isLegacyUser || user.emailVerified) {
                    currentUser = user; 
                    await loadUserAvatar(user.uid); 
                    db.collection('users').doc(user.uid).onSnapshot(doc => {
                        if(doc.exists) {
                            const d = doc.data();
                            currentUserStatus.banned = d.isBanned || false;
                            currentUserStatus.restrictedUntil = d.restrictedUntil ? d.restrictedUntil.toDate() : null;
                        }
                    });
                    updateLoginButton(); 
                    closeAuthModal(); 
                    listenForNotifications();
                } else {
                    currentUser = null; currentUserAvatar = null; currentUserStatus = { banned: false, restrictedUntil: null }; updateLoginButton();
                }
            } else { 
                if (notificationUnsubscribe) {
                    notificationUnsubscribe();
                    notificationUnsubscribe = null;
                }
                document.getElementById('notificationList').innerHTML = '';
                document.getElementById('notifBadge').style.display = 'none';

                currentUser = null; currentUserAvatar = null; currentUserStatus = { banned: false, restrictedUntil: null }; updateLoginButton(); 
            }
        });
    }

    function checkPermission() {
        if (!currentUser) { alert("Lütfen giriş yapın."); return false; }
        if (currentUserStatus.banned) { alert("Hesabınız süresiz olarak yasaklanmıştır."); return false; }
        if (currentUserStatus.restrictedUntil && currentUserStatus.restrictedUntil > new Date()) {
            alert("Hesabınız kısıtlanmıştır. Bitiş: " + currentUserStatus.restrictedUntil.toLocaleString()); return false;
        }
        return true;
    }

    async function loadUserAvatar(uid) {
        try {
            const doc = await db.collection('users').doc(uid).get();
            if(doc.exists && doc.data().photoBase64) currentUserAvatar = doc.data().photoBase64;
        } catch(e) { console.log(e); }
    }

    function updateLoginButton() {
        const container = document.getElementById('auth-container');
        if(currentUser) {
            const imgHtml = currentUserAvatar ? `<img src="${currentUserAvatar}" class="user-avatar">` : `<div class="user-avatar">${currentUser.displayName.charAt(0).toUpperCase()}</div>`;
            container.innerHTML = `
                <div id="loginBtnArea" style="display:none;"></div>
                <div class="notif-btn" id="leaderboardBtn" style="display:flex;" onclick="openLeaderboard()">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M280-120v-80h160v-124q-49-11-87.5-41.5T296-442q-75-9-125.5-65.5T120-640v-40q0-33 23.5-56.5T200-760h80v-80h400v80h80q33 0 56.5 23.5T840-680v40q0 76-50.5 132.5T664-442q-18 46-56.5 76.5T520-324v124h160v80H280Zm0-408v-152h-80v40q0 38 22 68.5t58 43.5Zm200 128q50 0 85-35t35-85v-240H360v240q0 50 35 85t85 35Zm200-128q36-13 58-43.5t22-68.5v-40h-80v152Zm-200-52Z"/></svg>
                </div>
                <div class="notif-btn" id="mainNotifBtn" style="display:flex;" onclick="showNotifications()">
                    <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg>
                    <div id="notifBadge" class="notif-badge"></div>
                </div>
                <div class="login-btn" onclick="openProfileModal()">${imgHtml}</div>`;
        } else {
            container.innerHTML = `<button class="login-btn text-mode" onclick="openAuthModal()">Giriş Yap</button>`;
        }
    }

    // --- MODAL YÖNETİMİ ---
    function closeAuthModal() { const m = document.getElementById('authModal'); const b = m.querySelector('.auth-box'); b.classList.remove('anim-zoom-in'); b.classList.add('anim-zoom-out'); setTimeout(() => { m.style.display = 'none'; b.classList.remove('anim-zoom-out'); b.classList.add('anim-zoom-in'); }, 250); }
    function closeProfileModal() { const m = document.getElementById('profileModal'); const b = m.querySelector('.auth-box'); b.classList.remove('anim-zoom-in'); b.classList.add('anim-zoom-out'); setTimeout(() => { m.style.display = 'none'; b.classList.remove('anim-zoom-out'); b.classList.add('anim-zoom-in'); }, 250); }
    function closeNotificationModal() { const m = document.getElementById('notificationModal'); const b = m.querySelector('.auth-box'); b.classList.remove('anim-zoom-in'); b.classList.add('anim-zoom-out'); setTimeout(() => { m.style.display = 'none'; b.classList.remove('anim-zoom-out'); b.classList.add('anim-zoom-in'); }, 250); }
    function closeAdminModal() { const m = document.getElementById('adminModal'); const b = m.querySelector('.auth-box'); b.classList.remove('anim-zoom-in'); b.classList.add('anim-zoom-out'); setTimeout(() => { m.style.display = 'none'; b.classList.remove('anim-zoom-out'); b.classList.add('anim-zoom-in'); }, 250); }
    function closeComments() { const m = document.getElementById('commentModal'); m.classList.remove('anim-slide-up'); m.classList.add('anim-slide-down'); setTimeout(() => { m.style.display = 'none'; m.classList.remove('anim-slide-down'); m.classList.add('anim-slide-up'); }, 350); }
    
    function closeLeaderboardModal() {
        const m = document.getElementById('leaderboardModal');
        const b = m.querySelector('.auth-box');
        b.classList.remove('anim-zoom-in');
        b.classList.add('anim-zoom-out');
        setTimeout(() => {
            m.style.display = 'none';
            b.classList.remove('anim-zoom-out');
            b.classList.add('anim-zoom-in');
        }, 250);
    }

    function closeHistoryModal() {
        const m = document.getElementById('historyModal');
        const b = m.querySelector('.auth-box');
        b.classList.remove('anim-zoom-in');
        b.classList.add('anim-zoom-out');
        setTimeout(() => {
            m.style.display = 'none';
            b.classList.remove('anim-zoom-out');
            b.classList.add('anim-zoom-in');
        }, 250);
    }

    function toggleModal() {
        const modal = document.getElementById('fullListModal'); const eyeIcon = document.getElementById('icon-eye'); const eyeOffIcon = document.getElementById('icon-eye-off');
        if (modal.style.display === 'flex') { 
            modal.classList.remove('anim-slide-up'); modal.classList.add('anim-slide-down');
            setTimeout(() => { modal.style.display = 'none'; modal.classList.remove('anim-slide-down'); modal.classList.add('anim-slide-up'); eyeIcon.style.display = 'block'; eyeOffIcon.style.display = 'none'; }, 350);
        } else { modal.style.display = 'flex'; eyeIcon.style.display = 'none'; eyeOffIcon.style.display = 'block'; renderFullList(currentMeal); }
    }

    // --- BİLDİRİM SİSTEMİ ---
    function listenForNotifications() {
        if (notificationUnsubscribe) {
            notificationUnsubscribe();
            notificationUnsubscribe = null;
        }

        if(!currentUser) return;

        notificationUnsubscribe = db.collection('notifications').where('receiverId', '==', currentUser.uid)
          .limit(50)
          .onSnapshot(snap => {
            const list = document.getElementById('notificationList');
            const badge = document.getElementById('notifBadge');
            let unreadCount = 0;
            
            if (snap.empty) {
                list.innerHTML = '<div class="notif-empty">Henüz bildirim yok.</div>';
                badge.style.display = 'none';
                return;
            }

            let notifs = [];
            snap.forEach(doc => {
                notifs.push({ id: doc.id, ...doc.data() });
            });
            
            notifs.sort((a, b) => {
                const timeA = a.createdAt ? a.createdAt.seconds : 0;
                const timeB = b.createdAt ? b.createdAt.seconds : 0;
                return timeB - timeA;
            });

            let html = '';
            notifs.forEach(n => {
                if(!n.read) unreadCount++;
                const isUnread = !n.read ? 'unread' : '';
                const time = timeAgo(n.createdAt);
                let text = '';
                if(n.type === 'like') text = `<b>${n.senderName}</b> yorumunu beğendi.`;
                if(n.type === 'reply') text = `<b>${n.senderName}</b> yorumuna yanıt verdi.`;
                if(n.type === 'profile_like') text = `<b>${n.senderName}</b> profilini beğendi.`;
                
                html += `
                    <div class="notif-item ${isUnread}" onclick="readNotification('${n.id}', '${n.docId}', '${n.commentId}')">
                        <div class="notif-text">${text}</div>
                        <div class="notif-time">${time}</div>
                    </div>
                `;
            });

            list.innerHTML = html;
            if (unreadCount > 0) {
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
          });
    }

    function sendNotification(receiverId, type, docId, commentId) {
        if (!currentUser || receiverId === currentUser.uid) return; 
        db.collection('notifications').add({
            receiverId: receiverId,
            senderId: currentUser.uid,
            senderName: currentUser.displayName,
            type: type, 
            docId: docId || null,
            commentId: commentId || null,
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    }

    function readNotification(notifId, docId, commentId) {
        db.collection('notifications').doc(notifId).update({ read: true });
        closeNotificationModal();
        if (docId && commentId && docId !== 'null') {
            navigateToComment(docId, commentId);
        }
    }

    function showNotifications() {
        document.getElementById('notificationModal').style.display = 'flex';
    }


    // --- AUTH FONKSİYONLARI ---
    function openAuthModal() { if(currentUser) return; document.getElementById('authModal').style.display = 'flex'; switchAuthTab('login'); }
    function switchAuthTab(tab) {
        document.getElementById('authTabs').style.display = 'flex';
        if(tab === 'login') { document.getElementById('loginForm').style.display = 'block'; document.getElementById('registerForm').style.display = 'none'; document.querySelectorAll('.auth-tab')[0].classList.add('active'); document.querySelectorAll('.auth-tab')[1].classList.remove('active'); } 
        else { document.getElementById('loginForm').style.display = 'none'; document.getElementById('registerForm').style.display = 'block'; document.querySelectorAll('.auth-tab')[0].classList.remove('active'); document.querySelectorAll('.auth-tab')[1].classList.add('active'); }
    }
    function handleAvatarSelect(input) { processImage(input, 'avatarPreview', (res) => selectedAvatarBase64 = res); }
    function handleProfileAvatarSelect(input) { processImage(input, 'profileAvatarPreview', (res) => profileAvatarBase64 = res); }
    function processImage(input, previewId, callback) {
        if (input.files && input.files[0]) {
            const file = input.files[0]; const reader = new FileReader();
            reader.onload = function(e) { const img = new Image(); img.onload = function() { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const maxSize = 150; let width = img.width; let height = img.height; if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } } else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } } canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height); const base64 = canvas.toDataURL('image/jpeg', 0.6); document.getElementById(previewId).src = base64; document.getElementById(previewId).style.display = 'block'; if(document.getElementById('avatarLabel')) document.getElementById('avatarLabel').style.display = 'none'; callback(base64); }; img.src = e.target.result; }
            reader.readAsDataURL(file);
        }
    }
    function loginUser() {
        const email = document.getElementById('loginEmail').value; const pass = document.getElementById('loginPass').value;
        if(!email || !pass) return alert("Bilgileri girin.");
        auth.signInWithEmailAndPassword(email, pass).then((userCredential) => {
            const user = userCredential.user; const createdTime = new Date(user.metadata.creationTime).getTime(); const isLegacyUser = createdTime < CHECK_VERIFICATION_DATE;
            if (!isLegacyUser && !user.emailVerified) { alert("Giriş başarısız! Doğrulama şart."); auth.signOut(); }
        }).catch(e => alert("Giriş Hatası: " + e.message));
    }
    async function startRegistration() {
        const nick = document.getElementById('regNick').value.trim(); const email = document.getElementById('regEmail').value.trim(); const pass = document.getElementById('regPass').value; const uni = document.getElementById('regUni').value; const dept = document.getElementById('regDept').value;
        if(!nick || !email || !pass || !uni || !dept) return alert("Tüm alanları doldurun."); if(pass.length < 6) return alert("Şifre kısa.");
        const englishCharRegex = /^[a-zA-Z0-9_.]+$/; if (!englishCharRegex.test(nick)) { return alert("Kullanıcı adı geçersiz karakter."); }
        try {
            const nickLower = nick.toLowerCase(); const snapshot = await db.collection('users').where('nickLower', '==', nickLower).get(); if(!snapshot.empty) return alert("Bu nick alınmış.");
            const userCred = await auth.createUserWithEmailAndPassword(email, pass); const user = userCred.user;
            await user.updateProfile({ displayName: nick });
            await db.collection('users').doc(user.uid).set({ nick: nick, nickLower: nickLower, email: email, university: uni, department: dept, photoBase64: selectedAvatarBase64 || null, profileLikeCount: 0 });
            const actionCodeSettings = { url: 'https://freddiechill.github.io/kyk-yemek/', handleCodeInApp: false, linkDomain: 'kyk-yemek-app.firebaseapp.com' };
            await user.sendEmailVerification(actionCodeSettings); alert("Kayıt başarılı! Maili onayla."); auth.signOut(); closeAuthModal();
        } catch(e) { alert("Hata: " + e.message); }
    }
    function openProfileModal() {
        if(!currentUser) return;
        document.getElementById('profileModal').style.display = 'flex'; document.getElementById('profileNick').value = currentUser.displayName;
        if(currentUserAvatar) document.getElementById('profileAvatarPreview').src = currentUserAvatar;
        db.collection('users').doc(currentUser.uid).get().then(doc => {
            if(doc.exists) { const data = doc.data(); if(data.university) { document.getElementById('profileUni').value = data.university; updateDeptOptions('profileUni', 'profileDept'); if(data.department) document.getElementById('profileDept').value = data.department; } }
        });
    }
    async function saveProfile() {
        const newNick = document.getElementById('profileNick').value.trim(); const uni = document.getElementById('profileUni').value; const dept = document.getElementById('profileDept').value; const newNickLower = newNick.toLowerCase();
        if(!newNick || !uni || !dept) return alert("Boş alan bırakma.");
        const englishCharRegex = /^[a-zA-Z0-9_.]+$/; if (!englishCharRegex.test(newNick)) { return alert("Geçersiz karakter."); }
        try {
            if(newNick !== currentUser.displayName) { const snapshot = await db.collection('users').where('nickLower', '==', newNickLower).get(); if(!snapshot.empty) return alert("Nick alınmış."); }
            await currentUser.updateProfile({ displayName: newNick });
            let updateData = { nick: newNick, nickLower: newNickLower, university: uni, department: dept };
            if(profileAvatarBase64) { updateData.photoBase64 = profileAvatarBase64; currentUserAvatar = profileAvatarBase64; }
            await db.collection('users').doc(currentUser.uid).set(updateData, { merge: true });
            const batch = db.batch(); const commentsSnap = await db.collection('comments').where('userId', '==', currentUser.uid).get();
            commentsSnap.forEach(doc => { batch.update(doc.ref, { userName: newNick, userPhoto: (profileAvatarBase64 || currentUserAvatar) }); });
            await batch.commit(); alert("Güncellendi!"); updateLoginButton(); closeProfileModal();
        } catch(e) { alert("Hata: " + e.message); }
    }
    function logoutUser() { auth.signOut(); closeProfileModal(); }

    // --- YORUM GEÇMİŞİ (YENİ MODAL) ---
    function openCommentHistory() {
        document.getElementById('profileModal').style.display = 'none'; 
        document.getElementById('historyModal').style.display = 'flex'; 
        loadUserCommentHistory();
    }
    function loadUserCommentHistory() {
        const list = document.getElementById('historyList'); list.innerHTML = '<div class="notif-empty">Yükleniyor...</div>';
        db.collection('comments').where('userId', '==', currentUser.uid).get().then(snap => {
            list.innerHTML = ''; 
            if(snap.empty) { list.innerHTML = '<div class="notif-empty">Henüz yorumun yok.</div>'; return; }
            let comments = [];
            snap.forEach(doc => { comments.push({ id: doc.id, ...doc.data() }); });
            comments.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            comments.forEach(c => {
                const time = timeAgo(c.createdAt);
                const mealLabel = (c.docId && c.docId.split('_')[0] === 'breakfast') ? 'KAHVALTI' : 'AKŞAM';
                list.innerHTML += `<div class="hist-item" onclick="navigateToComment('${c.docId}', '${c.id}')"><div class="hist-text">"${c.text}"</div><div class="hist-meta"><span>${mealLabel}</span><span>${time}</span></div></div>`;
            });
        });
    }

    // --- NAVIGASYON VE KIRMIZI YANIP SÖNME ---
    function navigateToComment(docId, commentId) {
        document.getElementById('historyModal').style.display = 'none';
        closeNotificationModal(); closeAdminModal();
        if(docId) {
            const parts = docId.split('_');
            if(parts.length === 3) {
                const mealType = parts[0]; const dayIdx = parseInt(parts[2]);
                if (currentMeal !== mealType) { currentMeal = mealType; updateTheme(); }
                let diff = dayIdx - currentDayIndex;
                while(diff !== 0) { if(diff > 0) { moveCarousel(1); diff--; } else { moveCarousel(-1); diff++; } }
                
                // HEDEF YORUMU AYARLA
                scrollTargetId = commentId;
                openComments(dayIdx);
            }
        }
    }

    // --- KULLANICI BİLGİ & LİDERLİK ---
    function handleUserClick(userId, userName, userPhoto) {
        selectedTargetUser = { id: userId, name: userName, photo: userPhoto };
        document.getElementById('adminUserImg').src = userPhoto || '';
        document.getElementById('adminUserName').innerText = userName;
        document.getElementById('adminUserUni').innerText = 'Yükleniyor...';
        document.getElementById('adminUserDept').innerText = 'Yükleniyor...';
        document.getElementById('profileLikeCount').innerText = '...';
        document.getElementById('likeIconTarget').classList.remove('is-liked');

        db.collection('users').doc(userId).get().then(doc => {
            if(doc.exists) {
                const d = doc.data();
                let uniDisplay = d.university || 'Belirtilmemiş';
                if (uniDisplay === 'SAÜ') uniDisplay = 'Sakarya Üniversitesi';
                if (uniDisplay === 'SUBÜ') uniDisplay = 'Sakarya Uygulamalı Bilimler Üniversitesi';
                
                document.getElementById('adminUserUni').innerText = uniDisplay;
                document.getElementById('adminUserDept').innerText = d.department || 'Belirtilmemiş';
                document.getElementById('profileLikeCount').innerText = d.profileLikeCount || 0;

                if (currentUser) {
                    db.collection('users').doc(userId).collection('likes').doc(currentUser.uid).get().then(likeDoc => {
                        if (likeDoc.exists) document.getElementById('likeIconTarget').classList.add('is-liked');
                    });
                }

                const isAdmin = (currentUser && currentUser.displayName === 'freddie');
                const toolsArea = document.getElementById('adminToolsArea');
                if (isAdmin) {
                    toolsArea.style.display = 'block';
                    const isBanned = d.isBanned || false; const restricted = d.restrictedUntil ? d.restrictedUntil.toDate() > new Date() : false;
                    if (isBanned || restricted) { document.getElementById('btnLiftBan').style.display = 'flex'; document.getElementById('btnGroupRestrict').style.display = 'none'; } 
                    else { document.getElementById('btnLiftBan').style.display = 'none'; document.getElementById('btnGroupRestrict').style.display = 'flex'; }
                    loadBanHistory(userId);
                } else { toolsArea.style.display = 'none'; }
            }
        });
        hideDurationOptions();
        document.getElementById('adminModal').style.display = 'flex';
    }

    function toggleProfileLike() {
        if (!currentUser) return alert("Giriş yapmalısın.");
        if (!selectedTargetUser) return;
        const targetId = selectedTargetUser.id;
        if (targetId === currentUser.uid) return alert("Kendini beğenemezsin.");

        const userRef = db.collection('users').doc(targetId);
        const likeRef = userRef.collection('likes').doc(currentUser.uid);

        db.runTransaction(async (t) => {
            const doc = await t.get(likeRef);
            const userDoc = await t.get(userRef);
            let newCount = (userDoc.data().profileLikeCount || 0);

            if (doc.exists) {
                t.delete(likeRef);
                newCount = Math.max(0, newCount - 1);
                t.update(userRef, { profileLikeCount: newCount });
                return false; 
            } else {
                t.set(likeRef, { at: firebase.firestore.FieldValue.serverTimestamp() });
                newCount = newCount + 1;
                t.update(userRef, { profileLikeCount: newCount });
                return true; 
            }
        }).then((liked) => {
            const icon = document.getElementById('likeIconTarget');
            const countSpan = document.getElementById('profileLikeCount');
            countSpan.innerText = parseInt(countSpan.innerText) + (liked ? 1 : -1);
            if (liked) icon.classList.add('is-liked'); else icon.classList.remove('is-liked');
            if(liked) sendNotification(targetId, 'profile_like', null, null); 
        }).catch(e => console.log(e));
    }

    function openLeaderboard(targetUserId = null) {
        document.getElementById('leaderboardModal').style.display = 'flex';
        const list = document.getElementById('leaderboardList');
        list.innerHTML = '<div class="notif-empty">Yükleniyor...</div>';
        
        db.collection('users').get().then(snap => {
            let users = [];
            snap.forEach(doc => {
                const d = doc.data();
                if (d.profileLikeCount && d.profileLikeCount > 0) {
                    users.push({ id: doc.id, ...d });
                }
            });
            users.sort((a, b) => b.profileLikeCount - a.profileLikeCount);

            list.innerHTML = '';
            if (users.length === 0) { list.innerHTML = '<div class="notif-empty">Henüz kimse beğenilmemiş.</div>'; return; }

            users.forEach((u, index) => {
                let rank = index + 1;
                let rankClass = '';
                if (rank === 1) rankClass = 'top1'; else if (rank === 2) rankClass = 'top2'; else if (rank === 3) rankClass = 'top3';
                let isMe = (currentUser && currentUser.uid === u.id) ? 'lb-self' : '';
                let targetClass = (targetUserId && targetUserId === u.id) ? 'row-highlight' : '';
                let rowId = `lb-row-${u.id}`;
                let avatarUrl = u.photoBase64 || ''; 
                let avatarHtml = avatarUrl ? `<img src="${avatarUrl}" class="lb-avatar">` : `<div class="lb-avatar" style="background:#ccc; display:flex; align-items:center; justify-content:center; color:#333; font-size:12px;">${u.nick.charAt(0).toUpperCase()}</div>`;

                list.innerHTML += `
                    <div id="${rowId}" class="lb-item ${isMe} ${targetClass}" onclick="handleUserClick('${u.id}', '${u.nick}', '${u.photoBase64}')">
                        <div class="lb-rank ${rankClass}">${rank}</div>
                        <div class="lb-user">${avatarHtml}<div class="lb-name">${u.nick}</div></div>
                        <div class="lb-score"><svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>${u.profileLikeCount}</div>
                    </div>
                `;
            });
            if (targetUserId) { setTimeout(() => { const el = document.getElementById(`lb-row-${targetUserId}`); if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 300); }
        });
    }

    function goToLeaderboardRank() {
        if(!selectedTargetUser) return;
        closeAdminModal();
        openLeaderboard(selectedTargetUser.id);
    }

    // --- BAN SİSTEMİ ---
    function loadBanHistory(userId) {
        const list = document.getElementById('adminBanHistory'); list.innerHTML = 'Yükleniyor...';
        db.collection('users').doc(userId).collection('banHistory').orderBy('date', 'desc').get().then(snap => {
            list.innerHTML = ''; if(snap.empty) { list.innerHTML = 'Kayıt yok.'; return; }
            snap.forEach(doc => {
                const h = doc.data(); const dateStr = h.date ? h.date.toDate().toLocaleString() : '';
                let actionClass = '', actionText = '';
                if(h.type === 'ban') { actionClass = 'banned'; actionText = 'BANLANDI'; } else if(h.type === 'restrict') { actionClass = 'restricted'; actionText = `KISITLANDI (${h.amount} ${h.unit})`; } else if(h.type === 'unban') { actionClass = 'unbanned'; actionText = 'KALDIRILDI'; }
                list.innerHTML += `<div class="history-item"><div><span class="h-action ${actionClass}">${actionText}</span></div><div class="h-date">${dateStr}</div></div>`;
            });
        });
    }
    function showDurationOptions() { document.getElementById('adminMainActions').style.display = 'none'; document.getElementById('adminDurationOptions').style.display = 'flex'; }
    function hideDurationOptions() { document.getElementById('adminMainActions').style.display = 'flex'; document.getElementById('adminDurationOptions').style.display = 'none'; }
    function logBanHistory(userId, type, amount, unit) { db.collection('users').doc(userId).collection('banHistory').add({ type: type, amount: amount || null, unit: unit || null, admin: currentUser.displayName, date: firebase.firestore.FieldValue.serverTimestamp() }); }
    function applyRestriction(amount, unit) {
        if(!selectedTargetUser) return;
        let hoursToAdd = 0; if (unit === 'saat') hoursToAdd = amount; if (unit === 'gün') hoursToAdd = amount * 24;
        const restrictedUntil = new Date(new Date().getTime() + hoursToAdd * 60 * 60 * 1000);
        db.collection('users').doc(selectedTargetUser.id).update({ isBanned: false, restrictedUntil: restrictedUntil }).then(() => { logBanHistory(selectedTargetUser.id, 'restrict', amount, unit); alert(selectedTargetUser.name + " " + amount + " " + unit + " kısıtlandı."); closeAdminModal(); });
    }
    function confirmBan() { if(!selectedTargetUser) return; if(confirm("Süresiz banlamak istiyor musun?")) { db.collection('users').doc(selectedTargetUser.id).update({ isBanned: true, restrictedUntil: null }).then(() => { logBanHistory(selectedTargetUser.id, 'ban'); alert("Kullanıcı banlandı."); closeAdminModal(); }); } }
    function liftBan() { if(!selectedTargetUser) return; db.collection('users').doc(selectedTargetUser.id).update({ isBanned: false, restrictedUntil: null }).then(() => { logBanHistory(selectedTargetUser.id, 'unban'); alert("Yasak kaldırıldı."); closeAdminModal(); }); }

    // --- DATA & RENDER & CAROUSEL ---
    const menuData = {
        1: { date: "1 Aralık 2025 Pazartesi", breakfast: ["Kaşarlı Omlet", "Kakaolu Kek", "Beyaz Peynir", "Siyah/Yeşil Zeytin", "Reçel Çeşitleri", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Kırmızı Mercimek Çorba/Yayla Çorba", "Tavuk Şiş+Fırın Sebze/Yeşil Mercimek Yemeği", "Şehriyeli Bulgur Pilavı", "Cacık", "500 ml Su", "Çeyrek Ekmek"] },
        2: { date: "2 Aralık 2025 Salı", breakfast: ["Zeytinli/Peynirli Açma", "Haşlanmış Yumurta", "Çeçil-Dil-Tel Peynir", "Siyah/Yeşil Zeytin", "Bal+Tereyağ", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Tavuk Çorba/Çeşmi Nigar Çorba", "Izgara Köfte+Sandviç Ekmeği+Söğüş Sebze/Karnabahar Kızartma", "Domatesli Spagetti", "Sütlaç", "500 ml Su", "Çeyrek Ekmek"] },
        3: { date: "3 Aralık 2025 Çarşamba", breakfast: ["Sucuklu Yumurta", "Peynirli Poğaça", "Labne Peynir", "Siyah/Yeşil Zeytin", "Mandalina", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Ezogelin Çorba/Mısır Çorba", "Tavuk Tantuni+Lavaş/Taze Fasulye Yemeği", "Sebzeli Bulgur Pilavı", "Yeşil Salata", "500 ml Su", "Çeyrek Ekmek"] },
        4: { date: "4 Aralık 2025 Perşembe", breakfast: ["Patates Kızartması", "Haşlanmış Yumurta", "Kaşar Peyniri", "Siyah/Yeşil Zeytin", "Mevsim Sebzeleri Söğüş", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Tel Şehriye Çorba/Tarhana Çorba", "Orman Kebabı/Ispanak Yemeği", "Pirinç Pilavı", "Pembe Sultan", "500 ml Su", "Çeyrek Ekmek"] },
        5: { date: "5 Aralık 2025 Cuma", breakfast: ["Menemen", "Simit", "Beyaz Peynir", "Siyah/Yeşil Zeytin", "Tahinli Pekmez", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Mantar Çorba/Kırmızı Mercimek Çorba", "Beşamel Soslu Tavuk/Mücver", "Soslu Mantı", "Kaşık Salata", "500 ml Su", "Çeyrek Ekmek"] },
        6: { date: "6 Aralık 2025 Cumartesi", breakfast: ["Sosis Kokteyl(Salçalı Veya Kızartma)/Patates Kavurması", "Haşlanmış Yumurta", "Kaşar Peyniri", "Siyah/Yeşil Zeytin", "Sürülebilir Çikolata", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Tavuk Çorba/Domates Çorba", "Nohut Yemeği/İmam Bayıldı", "Tel Şehriyeli Pirinç Pilavı", "Cevizli Baklava", "500 ml Su", "Çeyrek Ekmek"] },
        7: { date: "7 Aralık 2025 Pazar", breakfast: ["Peynirli Omlet", "Çikolatalı Milföy Börek", "Çeçil-Dil-Tel Peynir", "Siyah/Yeşil Zeytin", "Mevsim Sebzeleri Söğüş", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Kırmızı Mercimek Çorba/Yüksük Çorba", "Tavuk Fajita/Bezelye Yemeği", "Sebzeli Bulgur Pilavı", "Haydari", "500 ml Su", "Çeyrek Ekmek"] },
        8: { date: "8 Aralık 2025 Pazartesi", breakfast: ["Patates Kızartması", "Haşlanmış Yumurta", "Beyaz Peynir", "Siyah/Yeşil Zeytin", "Tahinli Pekmez", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Ezogelin Çorba/Sebze Çorba", "Et Tantuni+Lavaş/Pırasa Yemeği", "Arpa Şehriyeli Pirinç Pilavı", "Revani", "500 ml Su", "Çeyrek Ekmek"] },
        9: { date: "9 Aralık 2025 Salı", breakfast: ["Sade Omlet", "Dere Otlu Poğaça", "Kaşar Peyniri", "Siyah/Yeşil Zeytin", "Mevsim Sebzeleri Söğüş", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Kırmızı Mercimek Çorba/Yayla Çorba", "Tavuk Kalamar+Fırında Patates/Karışık Kızartma", "Soslu Mantı", "Akdeniz Salata", "500 ml Su", "Çeyrek Ekmek"] },
        10: { date: "10 Aralık 2025 Çarşamba", breakfast: ["Karışık Pizza", "Haşlanmış Yumurta", "Beyaz Peynir", "Siyah/Yeşil Zeytin", "Reçel Çeşitleri", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Yoğurt Çorba/Domates Çorba", "Adana Kebap+Lavaş+Domates+Biber/İmam Bayıldı", "Sebzeli Bulgur Pilavı", "Kabak Tatlısı", "500 ml Su", "Çeyrek Ekmek"] },
        11: { date: "11 Aralık 2025 Perşembe", breakfast: ["Patatesli Yumurta", "Simit", "Krem Peynir", "Siyah/Yeşil Zeytin", "Sürülebilir Çikolata", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Ezogelin Çorba/Düğün Çorba", "Tavuk Çökertme/Kabak Mücver", "Lor Peynirli Burgu Makarna", "Çiğ Köfte", "500 ml Su", "Çeyrek Ekmek"] },
        12: { date: "12 Aralık 2025 Cuma", breakfast: ["Peynirli Omlet", "Haşlanmış Yumurta", "Çeçil-Dil-Tel Peynir", "Siyah/Yeşil Zeytin", "Helva", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Kırmızı Mercimek Çorba/Tel Şehriye Çorba", "Kuru Fasulye Yemeği/Patates Yemeği", "Garnitürlü Pirinç Pilavı", "Gavurdağı Salata", "Yoğurt", "500 ml Su", "Çeyrek Ekmek"] },
        13: { date: "13 Aralık 2025 Cumartesi", breakfast: ["Sucuklu Yumurta", "Zeytinli/Peynirli Açma", "Beyaz Peynir", "Siyah/Yeşil Zeytin", "Mevsim Sebzeleri Söğüş", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Yoğurt Çorba/Tarhana Çorba", "İzmir Köfte/Biber Dolma", "Erişte", "Babagannuş", "500 ml Su", "Çeyrek Ekmek"] },
        14: { date: "14 Aralık 2025 Pazar", breakfast: ["Patates Kızartması", "Haşlanmış Yumurta", "Kaşar Peynir", "Siyah/Yeşil Zeytin", "Tahinli Pekmez", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Kırmızı Mercimek Çorba/Sebze Çorba", "Çıtır Tavuk+Patates Püresi/Karışık Sebze Graten", "Tel Şehriyeli Pirinç Pilavı", "Islak Kek", "500 ml Su", "Çeyrek Ekmek"] },
        15: { date: "15 Aralık 2025 Pazartesi", breakfast: ["Kaşarlı Omlet", "Sade Poğaça", "Beyaz Peynir", "Siyah/Yeşil Zeytin", "Bal+Tereyağ", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Sarı Mercimek Çorba/Tutmaç Çorba", "Çökertme Kebabı/Taze Fasulye Yemeği", "Domatesli Bulgur Pilavı", "Muz", "500 ml Su", "Çeyrek Ekmek"] },
        16: { date: "16 Aralık 2025 Salı", breakfast: ["Karışık Kızartma", "Haşlanmış Yumurta", "Kaşar Peyniri", "Siyah/Yeşil Zeytin", "Reçel Çeşitleri", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Ezogelin Çorba/Sebze Çorba", "Tavuk Külbastı+Fırında Patates/Ispanak Graten", "Arpa Şehriyeli Pirinç Pilavı", "Aysberg Salata", "500 ml Su", "Çeyrek Ekmek"] },
        17: { date: "17 Aralık 2025 Çarşamba", breakfast: ["Sade Omlet", "Peynirli Milföy Böreği", "Çeçil-Dil-Tel Peynir", "Siyah/Yeşil Zeytin", "Mevsim Sebzeleri Söğüş", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Kırmızı Mercimek Çorba/Domates Çorba", "Hamburger/Karışık Dolma", "Soslu Mantı", "Kısır", "500 ml Su", "Çeyrek Ekmek"] },
        18: { date: "18 Aralık 2025 Perşembe", breakfast: ["Sosis Kokteyl(Salçalı Veya Kızartma)/Patates Kroket", "Haşlanmış Yumurta", "Beyaz Peynir", "Siyah/Yeşil Zeytin", "Portakal", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Sarı Mercimek Çorba/Tel Şehriye Çorba", "Tavuk Tantuni+Lavaş/Mantar Graten", "Bahar Pilavı", "Supangle", "500 ml Su", "Çeyrek Ekmek"] },
        19: { date: "19 Aralık 2025 Cuma", breakfast: ["Peynirli Omlet", "Sade Kek", "Kaşar Peyniri", "Siyah/Yeşil Zeytin", "Sürülebilir Çikolata", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Yayla Çorba/Kırmızı Mercimek Çorba", "Orman Kebap/Karışık Sebze Graten", "Salçalı Bulgur Pilavı", "Çoban Salata", "500 ml Su", "Çeyrek Ekmek"] },
        20: { date: "20 Aralık 2025 Cumartesi", breakfast: ["Patates Kızartması", "Haşlanmış Yumurta", "Beyaz Peynir", "Siyah/Yeşil Zeytin", "Mevsim Sebzeleri Söğüş", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Ezogelin Çorba/Mısır Çorba", "Çıtır Tavuk+Fırında Elma Dilim Patates/Biber Dolma", "Soslu Mantı", "Çiğ Köfte", "500 ml Su", "Çeyrek Ekmek"] },
        21: { date: "21 Aralık 2025 Pazar", breakfast: ["Menemen", "Simit", "Labne Peynir", "Siyah/Yeşil Zeytin", "Tahinli Pekmez", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Tarhana Çorba/Tavuk Çorba", "Nohut Yemeği/Karışık Kızartma", "Arpa Şehriyeli Pirinç Pilavı", "Cevizli Kadayıf", "500 ml Su", "Çeyrek Ekmek"] },
        22: { date: "22 Aralık 2025 Pazartesi", breakfast: ["Zeytinli/Peynirli Açma", "Haşlanmış Yumurta", "Kaşar Peyniri", "Siyah/Yeşil Zeytin", "Bal+Tereyağ", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Ezogelin Çorba/Yayla Çorba", "Tavuk Baby+Fırında Elma Dilim Patates/Lahana Dolma", "Spagetti Napoliten", "Mevsim Salata", "500 ml Su", "Çeyrek Ekmek"] },
        23: { date: "23 Aralık 2025 Salı", breakfast: ["Sucuklu Yumurta", "Dere Otlu Poğaça", "Beyaz Peynir", "Siyah/Yeşil Zeytin", "Mevsim Sebzeleri Söğüş", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Tavuk Çorba/Kırmızı Mercimek Çorba", "Et Tantuni+Lavaş/Taze Fasulye Yemeği", "Arpa Şehriyeli Pirinç Pilavı", "Ayran", "500 ml Su", "Çeyrek Ekmek"] },
        24: { date: "24 Aralık 2025 Çarşamba", breakfast: ["Patates Kızartması", "Haşlanmış Yumurta", "Çeçil-Dil-Tel Peynir", "Siyah/Yeşil Zeytin", "Sürülebilir Çikolata", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Tel Şehriye Çorba/Sarı Mercimek Çorba", "Tavuk Köfte+Elma Dilim Patates/Bezelye Yemeği", "Bulgur Pilavı", "Browni", "500 ml Su", "Çeyrek Ekmek"] },
        25: { date: "25 Aralık 2025 Perşembe", breakfast: ["Kaşarlı Omlet", "Sade Açma", "Beyaz Peynir", "Siyah/Yeşil Zeytin", "Helva", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Kırmızı Mercimek Çorba/Domates Çorba", "Çiftlik Köfte/Barbunya Yemeği", "Tel Şehriyeli Pirinç Pilavı", "Kuru Cacık", "500 ml Su", "Çeyrek Ekmek"] },
        26: { date: "26 Aralık 2025 Cuma", breakfast: ["Karışık Pizza", "Haşlanmış Yumurta", "Labne Peynir", "Siyah/Yeşil Zeytin", "Reçel Çeşitleri", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Ezogelin Çorba/Mısır Çorba", "Çıtır Tavuk+Fırında Elma Dilim Patates/Kuru Patlıcan Dolma", "Burgu Makarna", "Karışık Salata", "500 ml Su", "Çeyrek Ekmek"] },
        27: { date: "27 Aralık 2025 Cumartesi", breakfast: ["Peynirli Omlet", "Simit", "Kaşar Peynir", "Siyah/Yeşil Zeytin", "Tahinli Pekmez", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Tel Şehriye Çorba/Tarhana Çorba", "Kuru Fasulye Yemeği/Karışık Sebze Graten", "Pirinç Pilavı", "Kemalpaşa", "Karışık Turşu", "500 ml Su", "Çeyrek Ekmek"] },
        28: { date: "28 Aralık 2025 Pazar", breakfast: ["Patates Kızartması", "Haşlanmış Yumurta", "Beyaz Peynir", "Siyah/Yeşil Zeytin", "Mevsim Sebzeleri Söğüş", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Kırmızı Mercimek Çorba/Tavuk Çorba", "Izgara Köfte+Domates+Biber/Patates Yemeği", "Bulgur Pilavı", "Ayran", "500 ml Su", "Çeyrek Ekmek"] },
        29: { date: "29 Aralık 2025 Pazartesi", breakfast: ["Sade Omlet", "Çikolatalı Milföy Börek", "Çeçil-Dil-Tel Peynir", "Siyah/Yeşil Zeytin", "Muz", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Ezogelin Çorba/Yayla Çorba", "Tavuk Şinitzel+Elma Dilim Patates+Mevsim Salata/Karnabahar Kızartması", "Soslu Penne Makarna", "Trileçe", "500 ml Su", "Çeyrek Ekmek"] },
        30: { date: "30 Aralık 2025 Salı", breakfast: ["Peynirli Börek", "Haşlanmış Yumurta", "Kaşar Peyniri", "Siyah/Yeşil Zeytin", "Sürülebilir Çikolata", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Kırmızı Mercimek Çorba/Tavuk Çorba", "Çökertme Kebabı/Taze Fasulye Yemeği", "Tel Şehriyeli Pirinç Pilavı", "Çiğ Köfte", "500 ml Su", "Çeyrek Ekmek"] },
        31: { date: "31 Aralık 2025 Çarşamba", breakfast: ["Patatesli Yumurta", "Simit", "Beyaz Peynir", "Siyah/Yeşil Zeytin", "Mevsim Sebzeleri Söğüş", "500 ml Su", "Çeyrek Ekmek"], dinner: ["Ezogelin Çorba/Soğan Çorba", "Fırında Uskumru+Sebze/Lahana Dolması", "İrmik Helvası", "Yeşil Salata", "500 ml Su", "Çeyrek Ekmek"] }
    };

    let currentMeal = 'dinner', currentDayIndex = new Date().getDate(), cardPositions = [0, 1, 2, 3, 4];
    const cards = [document.getElementById('c0'), document.getElementById('c1'), document.getElementById('c2'), document.getElementById('c3'), document.getElementById('c4')];

    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date(); 
        // Aralık ayında değilsek 1. güne eşitle (Test amaçlı)
        if(today.getMonth() !== 11 || currentDayIndex > 31) currentDayIndex = 1; 
        updateTheme(); renderAllCards(currentDayIndex); applyClasses();
        const eyeIcon = document.getElementById('icon-eye'), eyeOffIcon = document.getElementById('icon-eye-off');
        if(eyeIcon && eyeOffIcon) { eyeIcon.style.display = 'block'; eyeOffIcon.style.display = 'none'; }
    });

    function getLoopedIndex(idx) { let val = idx; while(val<1) val+=31; while(val>31) val-=31; return val; }
    function renderAllCards(centerDateIdx) {
        for (let i = 0; i < 5; i++) {
            const domIndex = cardPositions[i]; const dateOffset = i - 2; const targetDateIdx = getLoopedIndex(centerDateIdx + dateOffset); const card = cards[domIndex];
            card.innerHTML = `
                <div class="card-header"><div class="meal-title">${currentMeal === 'breakfast' ? 'KAHVALTI' : 'AKŞAM'}</div><button class="switch-btn ${i===2?'':'hidden-btn'}" onclick="toggleMealType()"><span class="switch-text">${currentMeal === 'breakfast' ? 'Akşama Geç' : 'Kahvaltıya Geç'}</span><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M16.01 11H4v2h12.01v3L20 12l-3.99-4z"/></svg></button></div>
                <ul>${getMenuHtml(targetDateIdx)}</ul>
                <div class="social-footer">
                    <div class="social-action" onclick="handleVote(${targetDateIdx}, 'like')"><svg viewBox="0 0 24 24"><path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-1.91l-.99-.01z"/></svg><span class="count-text" id="like-count-${targetDateIdx}">0</span></div>
                    <div class="social-action" onclick="handleVote(${targetDateIdx}, 'dislike')"><svg viewBox="0 0 24 24" class="flip-icon"><path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-1.91l-.99-.01z"/></svg><span class="count-text" id="dislike-count-${targetDateIdx}">0</span></div>
                    <div class="social-action" onclick="openComments(${targetDateIdx})"><button class="notif-btn anim-pop" style="display:none"></button> <svg viewBox="0 0 24 24"><path d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18z"/></svg><span class="count-text" id="comment-count-${targetDateIdx}">0</span></div>
                </div>`;
            if(i===2) { document.getElementById('currentDate').innerText = menuData[targetDateIdx].date; fetchStats(targetDateIdx); }
        }
    }
    function getMenuHtml(idx) { const items = (menuData[idx] && menuData[idx][currentMeal]) ? menuData[idx][currentMeal] : ["Veri yok"]; return items.map(i => `<li>${i}</li>`).join(''); }
    function moveCarousel(direction) { if(direction===1) { cardPositions.push(cardPositions.shift()); currentDayIndex = getLoopedIndex(currentDayIndex+1); } else { cardPositions.unshift(cardPositions.pop()); currentDayIndex = getLoopedIndex(currentDayIndex-1); } renderAllCards(currentDayIndex); applyClasses(); }
    function applyClasses() { const classes = ['pos-0', 'pos-1', 'pos-2', 'pos-3', 'pos-4']; for(let i=0; i<5; i++) { const el = cards[cardPositions[i]]; el.classList.remove(...classes); el.classList.add(classes[i]); } }
    function toggleMealType() { currentMeal = currentMeal === 'dinner' ? 'breakfast' : 'dinner'; updateTheme(); renderAllCards(currentDayIndex); }
    function updateTheme() { document.body.className = currentMeal === 'breakfast' ? 'theme-breakfast' : 'theme-dinner'; }
    
    function renderFullList(mealType) {
        const container = document.getElementById('fullListContainer'); 
        const btnBreakfast = document.getElementById('modalBtnBreakfast'); 
        const btnDinner = document.getElementById('modalBtnDinner'); 
        container.innerHTML = ''; 
        btnBreakfast.className = 'modal-toggle'; 
        btnDinner.className = 'modal-toggle';
        if (mealType === 'breakfast') btnBreakfast.classList.add('active-yellow'); 
        else btnDinner.classList.add('active-red');
        for (let i = 1; i <= 31; i++) { 
            const dayData = menuData[i]; 
            if (dayData) { 
                const div = document.createElement('div'); 
                div.className = 'day-row'; 
                div.innerHTML = `<div class="day-header">${dayData.date}</div><div class="day-content">${dayData[mealType].join('<br>')}</div>`; 
                container.appendChild(div); 
            } 
        }
    }

    function fetchStats(dayIdx) { if(!db) return; const docId = `${currentMeal}_${CURRENT_MONTH_TAG}_${dayIdx}`; db.collection('daily_stats').doc(docId).onSnapshot(doc => { if(doc.exists) { const data = doc.data(); const likeEl = document.getElementById(`like-count-${dayIdx}`); const dislikeEl = document.getElementById(`dislike-count-${dayIdx}`); const commentEl = document.getElementById(`comment-count-${dayIdx}`); if(likeEl) likeEl.innerText = data.likes || 0; if(dislikeEl) dislikeEl.innerText = data.dislikes || 0; if(commentEl) commentEl.innerText = data.commentCount || 0; if(currentUser && data.votes && data.votes[currentUser.uid]) { if(data.votes[currentUser.uid] === 'like') { document.getElementById(`like-count-${dayIdx}`).parentElement.classList.add('liked'); document.getElementById(`dislike-count-${dayIdx}`).parentElement.classList.remove('disliked'); } else { document.getElementById(`dislike-count-${dayIdx}`).parentElement.classList.add('disliked'); document.getElementById(`like-count-${dayIdx}`).parentElement.classList.remove('liked'); } } } }); db.collection('comments').where('docId', '==', docId).onSnapshot(snap => { const count = snap.size; const el = document.getElementById(`comment-count-${dayIdx}`); if(el) el.innerText = count; db.collection('daily_stats').doc(docId).set({ commentCount: count }, { merge: true }); }); }
    function handleVote(dayIdx, type) { if(!currentUser) return alert("Lütfen giriş yapın."); if(!checkPermission()) return; const eventTarget = event.currentTarget; eventTarget.classList.add('anim-pop'); setTimeout(() => eventTarget.classList.remove('anim-pop'), 300); const ref = db.collection('daily_stats').doc(`${currentMeal}_${CURRENT_MONTH_TAG}_${dayIdx}`); db.runTransaction(async (t) => { const doc = await t.get(ref); if(!doc.exists) { t.set(ref, { likes: 0, dislikes: 0, commentCount: 0, votes: {} }); } const data = doc.data() || { likes: 0, dislikes: 0, commentCount: 0, votes: {} }; const votes = data.votes || {}; const current = votes[currentUser.uid]; let likes = data.likes || 0; let dislikes = data.dislikes || 0; if(current === type) { if(type === 'like') likes--; else dislikes--; delete votes[currentUser.uid]; } else { if(current === 'like') likes--; if(current === 'dislike') dislikes--; if(type === 'like') likes++; else dislikes++; votes[currentUser.uid] = type; } t.update(ref, { likes, dislikes, votes }); }); }
    
    let activeCommentDay = 0;
    function openComments(dayIdx) { activeCommentDay = dayIdx; document.getElementById('commentModal').style.display = 'flex'; loadComments(dayIdx); }
    
    function loadComments(dayIdx) { const list = document.getElementById('commentList'); list.innerHTML = '<div style="text-align:center; color:#888; margin-top:20px;">Yükleniyor...</div>'; if(!db) { list.innerHTML = '<div style="text-align:center; color:#888;">Bağlantı yok.</div>'; return; } const docId = `${currentMeal}_${CURRENT_MONTH_TAG}_${dayIdx}`; db.collection('comments').where('docId', '==', docId).onSnapshot(snapshot => { const realCount = snapshot.size; db.collection('daily_stats').doc(docId).set({ commentCount: realCount }, { merge: true }); list.innerHTML = ''; if(snapshot.empty) { list.innerHTML = '<div style="text-align:center; color:#888;">Henüz yorum yok.</div>'; return; } let allComments = []; snapshot.forEach(doc => { allComments.push({ id: doc.id, ...doc.data() }); }); let rootComments = allComments.filter(c => !c.parentId).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); const getChildren = (parentId) => allComments.filter(c => c.parentId === parentId).sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)); const renderTree = (comment) => { let html = createCommentHTML(comment, false); let children = getChildren(comment.id); children.forEach(child => { html += createCommentHTML(child, true); html += renderChildrenOf(child); }); return html; }; const renderChildrenOf = (parent) => { let html = ''; let children = getChildren(parent.id); children.forEach(child => { html += createCommentHTML(child, true); html += renderChildrenOf(child); }); return html; }; rootComments.forEach(root => { list.innerHTML += renderTree(root); }); if(scrollTargetId) { setTimeout(() => { const el = document.getElementById('comment-'+scrollTargetId); if(el) { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); el.classList.add('highlight-comment'); setTimeout(() => el.classList.remove('highlight-comment'), 2000); } scrollTargetId = null; }, 500); } }); }
    function timeAgo(date) { if (!date) return ''; const seconds = Math.floor((new Date() - date.toDate()) / 1000); let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + "y"; interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + "ay"; interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + "g"; interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + "sa"; interval = seconds / 60; if (interval > 1) return Math.floor(interval) + "dk"; return "Şimdi"; }
    function createCommentHTML(c, isReply) { let avatarHtml = c.userPhoto ? `<img src="${c.userPhoto}" class="c-avatar" onclick="handleUserClick('${c.userId}', '${c.userName}', '${c.userPhoto}')">` : `<div class="c-avatar" onclick="handleUserClick('${c.userId}', '${c.userName}', '')" style="display:flex;align-items:center;justify-content:center;color:#555;background:#ccc;font-weight:bold;font-size:14px;cursor:pointer;">${c.userName.charAt(0).toUpperCase()}</div>`; let badgeHtml = ''; if(c.userName === 'freddie') { badgeHtml = '<svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:#FFD700;margin-left:4px;vertical-align:text-bottom;"><path d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5zm14 3c0 .6-.4 1-1 1H6c-.6 0-1-.4-1-1v-1h14v1z"/></svg>'; } else if(c.userName === 'Saya' || c.userName === 'saya') { badgeHtml = '<img src="https://raw.githubusercontent.com/freddiechill/gorsel-depom/59349c4a1cbc0e97cc30e17192a4f1bf024fa852/seytan-boynuz.svg" class="badge-icon" alt="badge">'; } let deleteBtn = ''; if(currentUser && (currentUser.uid === c.userId || currentUser.displayName === 'freddie')) { deleteBtn = `<span class="delete-comment-btn" onclick="deleteComment('${c.id}', '${c.docId}')"><i class="fas fa-trash"></i></span>`; } let replyBtn = ''; if(currentUser) { replyBtn = `<div class="reply-trigger" onclick="toggleReplyBox('${c.id}')">YANITLA</div>`; } let replyClass = isReply ? 'reply-comment' : ''; let replyIcon = isReply ? '<svg class="reply-icon" viewBox="0 0 24 24"><path d="M19 7v4H5.83l3.58-3.59L8 6l-6 6 6 6 1.41-1.41L5.83 13H21V7z"/></svg>' : ''; let mentionHtml = c.replyTo ? `<span class="mention-text">@${c.replyTo}</span>` : ''; let timeString = timeAgo(c.createdAt); let hasDelete = (deleteBtn !== '') ? 'has-delete' : ''; const clickAttr = `onclick="handleUserClick('${c.userId}', '${c.userName}', '${c.userPhoto || ''}')"`; if(c.userPhoto) { avatarHtml = `<img src="${c.userPhoto}" class="c-avatar" ${clickAttr}>`; } else { avatarHtml = `<div class="c-avatar" ${clickAttr} style="display:flex;align-items:center;justify-content:center;color:#555;background:#ccc;font-weight:bold;font-size:14px;cursor:pointer;">${c.userName.charAt(0).toUpperCase()}</div>`; } return `<div class="single-comment ${replyClass} ${hasDelete}" id="comment-${c.id}">${replyIcon}<div class="time-ago">${timeString}</div>${deleteBtn}<div class="c-top">${avatarHtml}<div class="c-content"><div class="c-user" onclick="handleUserClick('${c.userId}', '${c.userName}', '${c.userPhoto}')">${c.userName}${badgeHtml}</div><div class="c-text">${mentionHtml}${c.text}</div></div></div><div class="c-actions"><div class="c-action-btn" onclick="handleCommentVote('${c.id}', 'like', '${c.userId}')"><svg viewBox="0 0 24 24"><path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-1.91l-.99-.01z"/></svg><span id="clike-${c.id}">${c.likes || 0}</span></div><div class="c-action-btn" onclick="handleCommentVote('${c.id}', 'dislike', '${c.userId}')"><svg viewBox="0 0 24 24" class="flip-icon"><path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-1.91l-.99-.01z"/></svg><span id="cdislike-${c.id}">${c.dislikes || 0}</span></div>${replyBtn}</div><div id="reply-box-${c.id}" class="reply-input-wrapper"><input type="text" id="reply-input-${c.id}" class="reply-input" placeholder="Yanıt yaz..."><button class="reply-send-btn" onclick="postReply('${c.id}', '${c.docId}', '${c.userName}', '${c.userId}')"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button></div></div>`; }
    function toggleReplyBox(commentId) { const box = document.getElementById(`reply-box-${commentId}`); if(box.style.display === 'flex') box.style.display = 'none'; else box.style.display = 'flex'; }
    function postReply(parentId, docId, replyToUser, replyToUserId) { 
        if(!checkPermission()) return; 
        const input = document.getElementById(`reply-input-${parentId}`); 
        const text = input.value.trim(); 
        if(!text) return; 
        
        db.collection('comments').add({ 
            docId: docId, text: text, userId: currentUser.uid, userName: currentUser.displayName, userPhoto: currentUserAvatar, likes: 0, dislikes: 0, votes: {}, parentId: parentId, replyTo: replyToUser, createdAt: firebase.firestore.FieldValue.serverTimestamp() 
        }).then(() => {
            if(replyToUserId) sendNotification(replyToUserId, 'reply', docId, parentId);
        });
        
        input.value = ''; toggleReplyBox(parentId); 
    }
    
    async function deleteComment(commentId, docId) { if(!confirm("Silmek istiyor musun?")) return; const docSnapshot = await db.collection('comments').doc(commentId).get(); const docData = docSnapshot.data(); const idsToDelete = [commentId]; const snapshot = await db.collection('comments').where('docId', '==', docId).get(); let allComments = []; snapshot.forEach(doc => allComments.push({ id: doc.id, ...doc.data() })); const findChildren = (pId) => { const children = allComments.filter(c => c.parentId === pId); children.forEach(child => { idsToDelete.push(child.id); findChildren(child.id); }); }; findChildren(commentId); const batch = db.batch(); idsToDelete.forEach(id => { const ref = db.collection('comments').doc(id); batch.delete(ref); }); await batch.commit(); }
    
    function handleCommentVote(commentId, type, ownerId) { 
        if(!currentUser) return alert("Lütfen giriş yapın."); 
        if(!checkPermission()) return; 
        const eventTarget = event.currentTarget; 
        eventTarget.classList.add('anim-pop'); 
        setTimeout(() => eventTarget.classList.remove('anim-pop'), 300); 
        
        const ref = db.collection('comments').doc(commentId); 
        db.runTransaction(async (t) => { 
            const doc = await t.get(ref); 
            if(!doc.exists) return { success: false }; 
            const data = doc.data(); 
            const votes = data.votes || {}; 
            const current = votes[currentUser.uid]; 
            let likes = data.likes || 0; 
            let dislikes = data.dislikes || 0; 
            let shouldNotify = false; 
            
            if(current === type) { 
                if(type === 'like') likes--; else dislikes--; 
                delete votes[currentUser.uid]; 
            } else { 
                if(current === 'like') likes--; 
                if(current === 'dislike') dislikes--; 
                if(type === 'like') { likes++; shouldNotify = true; } else dislikes++; 
                votes[currentUser.uid] = type; 
            } 
            t.update(ref, { likes, dislikes, votes }); 
            return { success: true, shouldNotify: shouldNotify, docId: data.docId };
        }).then((result) => {
            if(result.success && result.shouldNotify && ownerId) {
                sendNotification(ownerId, 'like', result.docId, commentId);
            }
        }); 
    }

    function postComment() { if(!currentUser) return alert("Giriş yapmalısınız."); if(!checkPermission()) return; const input = document.getElementById('commentInput'); const text = input.value.trim(); if(!text) return; const docId = `${currentMeal}_${CURRENT_MONTH_TAG}_${activeCommentDay}`; db.collection('comments').add({ docId: docId, text: text, userId: currentUser.uid, userName: currentUser.displayName, userPhoto: currentUserAvatar, likes: 0, dislikes: 0, votes: {}, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); input.value = ''; }
    function getLoopedIndex(idx) { let val = idx; while(val<1) val+=31; while(val>31) val-=31; return val; }

    let touchStartX = 0; let touchEndX = 0; const carousel = document.getElementById('carouselTouchArea'); carousel.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }); carousel.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; handleSwipe(); }); function handleSwipe() { if (touchEndX < touchStartX - 50) moveCarousel(1); if (touchEndX > touchStartX + 50) moveCarousel(-1); }
</script>

</body>
</html>
